<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBS Agent æ§åˆ¶å°</title>
  <style>
    :root{
      --bg:#f7f7f5; --panel:#ffffff; --muted:#6b7280; --text:#0a1a3f;
      --primary:#1e3a8a; --border:#e5e7eb; --code:#f3f4f6;
      --ok:#16a34a; --bad:#dc2626;
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text);
      font:14px/1.58 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif }
    .wrap{ max-width:860px; margin:18px auto 28px; padding:0 14px; }
    .hdr{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .hdr h2{ margin:0; font-size:18px; font-weight:800 }

    .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px;
      padding:14px; box-shadow:0 4px 12px rgba(2,6,23,.06); margin-bottom:12px; }

    /* çµ±ä¸€æ’ç‰ˆï¼šå·¦å´å›ºå®šå¯¬çš„ label + å³å´æ¬„ä½ï¼Œå…¨éƒ¨æ°´å¹³å°é½Š */
    .form-grid{
      display:grid; grid-template-columns: 120px 1fr auto; gap:10px 12px; align-items:center;
    }
    .form-grid .full{ grid-column: 1 / -1; }

    label{ font-weight:700; font-size:13px; color:#0b1639 }
    input, select{
      width:100%; padding:10px 12px; background:#fafafa; color:var(--text);
      border:1px solid var(--border); border-radius:10px; outline:none; transition:.2s;
    }
    input:focus, select:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px #dbeafe }

    .btn{ appearance:none; border:none; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer }
    .btn-start{ background:#1e3a8a; color:#fff }
    .btn-info{ background:#e0e7ff; color:#1e293b; border:1px solid #c7d2fe }
    .btn-stop{ background:#f3f4f6; color:#111827; border:1px solid var(--border) }
    .btn-close{ background:#111827; color:#fff }

    .badges{ display:flex; gap:8px; align-items:center; }
    .badge{ display:inline-flex; align-items:center; justify-content:center;
      height:22px; padding:0 10px; border-radius:999px; font-weight:700; font-size:12px }
    .ok{ background:#ecfdf5; color:var(--ok); border:1px solid #bbf7d0 }
    .bad{ background:#fef2f2; color:var(--bad); border:1px solid #fecaca }
    .muted{ background:#eef2ff; color:#475569; border:1px solid #e2e8f0 }

    .row-btns{ display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px; }
    .log{
      white-space:pre-wrap; overflow:auto; background:var(--code); border:1px solid var(--border);
      border-radius:10px; padding:12px; min-height:420px; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px;
    }

    /* éŸ³æ¨‚åˆ— */
    .music { display:flex; align-items:center; gap:12px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px;
      border:1px solid #bcd0ff; color:#1e3a8a; background:#fff; font-weight:700; text-decoration:none }
    audio{ height:28px }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <h2>ğŸ  CBS Agent æ§åˆ¶å°</h2>
      <div class="music">
        <a class="pill" href="https://line.me/R/ti/p/@307momvl" target="_blank" rel="noopener">LINE å®˜æ–¹</a>
        <audio id="bgm" controls src="https://dw5000tw-33.github.io/fbauto/the-truth-194426.mp3"></audio>
      </div>
    </div>

    <!-- è¨­å®šå¡ -->
    <div class="card">
      <div class="form-grid">
        <label for="api">API Base</label>
        <input id="api" placeholder="ä¾‹å¦‚ https://cbs-agent-docker.onrender.com" />
        <button id="save" class="btn btn-stop">ğŸ’¾ å„²å­˜</button>

        <label for="key">X-API-KEY</label>
        <input id="key" placeholder="å¯ç•™ç™½" />
        <div class="badges">
          <button id="ping" class="btn btn-info">ğŸ” å¥åº·æª¢æŸ¥</button>
          <span id="healthStat" class="badge muted">æœªçŸ¥</span>
        </div>

        <label for="mode">æ¨¡å¼</label>
        <select id="mode">
          <option value="exact">exactï¼ˆç²¾æº–ï¼‰</option>
          <option value="fuzzy">fuzzyï¼ˆå¯¬é¬†ï¼‰</option>
        </select>
        <div></div>
      </div>
    </div>

    <!-- å‹•ä½œå¡ -->
    <div class="card">
      <div class="form-grid">
        <label for="addr">æŸ¥è©¢åœ°å€</label>
        <input id="addr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚å—å±¯å€å¤§å¢©å—è·¯356è™Ÿ" />
        <div></div>

        <div class="full row-btns">
          <button class="btn btn-start" id="echo">Echo æ¸¬è©¦</button>
          <button class="btn btn-info"  id="runCombo">åŸ·è¡Œ Combo</button>
          <button class="btn btn-stop"  id="runBigfun">åƒ… BigFun</button>
          <button class="btn btn-close" id="abort" disabled>ä¸­æ­¢</button>
        </div>

        <label class="full" for="log">æ—¥èªŒè¼¸å‡º</label>
        <textarea id="log" class="log" spellcheck="false" placeholder="é€™è£¡æœƒé¡¯ç¤ºä¸²æµæ—¥èªŒ..."></textarea>
      </div>
    </div>
  </div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ åŸºç¤å·¥å…· â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $ = (id)=>document.getElementById(id);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function appendLog(t){
  const ta=$('log');
  const line = (typeof t==='string') ? t : JSON.stringify(t,null,2);
  ta.value += line + '\n';
  ta.scrollTop = ta.scrollHeight;
}
function clearLog(){ $('log').value=''; }
function setBadge(el, kind, text){ el.className = 'badge ' + (kind||'muted'); el.textContent = text; }

/* ç‹€æ…‹ä¿å­˜ */
const state = {
  get api(){ return localStorage.getItem('api') || '' },
  set api(v){ localStorage.setItem('api', v||'') },
  get key(){ return localStorage.getItem('key') || '' },
  set key(v){ localStorage.setItem('key', v||'') },
  get mode(){ return localStorage.getItem('mode') || 'exact' },
  set mode(v){ localStorage.setItem('mode', v||'exact') },
};
(function init(){
  $('api').value  = state.api;
  $('key').value  = state.key;
  $('mode').value = state.mode;
})();

function base(){ return (state.api||'').replace(/\/$/,''); }
function headers(){
  const h={'Content-Type':'application/json'};
  const k=(state.key||'').trim();
  if(k) h['x-api-key']=k;
  return h;
}
async function GET(path){
  const r = await fetch(base()+path,{ headers:headers() });
  if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  const ct = r.headers.get('content-type')||'';
  return ct.includes('application/json') ? r.json() : r.text();
}
async function POST(path, body){
  const r = await fetch(base()+path,{
    method:'POST', headers:headers(),
    body: JSON.stringify(body||{})
  });
  if(!r.ok && r.status!==202) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}

/* è§£æåœ°å€ï¼ˆåƒ…å›å‚³ç°¡å–®ç‰‡æ®µï¼Œä¾› Echo å±•ç¤ºï¼‰ */
function parseTaiwanAddress(s){
  if(!s) return {};
  s = s.replace(/è‡º/g,'å°').replace(/\s+/g,'').trim();
  const mCity=s.match(/^(å°åŒ—å¸‚|æ–°åŒ—å¸‚|æ¡ƒåœ’å¸‚|å°ä¸­å¸‚|å°å—å¸‚|é«˜é›„å¸‚|åŸºéš†å¸‚|æ–°ç«¹å¸‚|å˜‰ç¾©å¸‚|æ–°ç«¹ç¸£|è‹—æ —ç¸£|å½°åŒ–ç¸£|å—æŠ•ç¸£|é›²æ—ç¸£|å˜‰ç¾©ç¸£|å±æ±ç¸£|å®œè˜­ç¸£|èŠ±è“®ç¸£|å°æ±ç¸£|æ¾æ¹–ç¸£|é‡‘é–€ç¸£|é€£æ±Ÿç¸£)/);
  const city=mCity?mCity[1]:'';
  s = city ? s.slice(city.length): s;
  const mTown=s.match(/^(.+?[å¸‚å€é„‰é®])/); const town=mTown?mTown[1]:'';
  s = town ? s.slice(town.length) : s;
  const mRoad=s.match(/^(.+?(?:è·¯|è¡—|å¤§é“|é“)(?:[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å0-9]+æ®µ)?)/);
  let road=''; if(mRoad){ road=mRoad[1]; s=s.slice(road.length); }
  const lane =(s.match(/(\d+)\s*å··/)||[, ''])[1];
  const alley=(s.match(/(\d+)\s*å¼„/)||[, ''])[1];
  const num  =(s.match(/(\d+(?:-\d+)?)\s*è™Ÿ/)||[, ''])[1];
  const floor=(s.match(/(\d+)\s*æ¨“/)||[, ''])[1];
  return { city,town,road,lane,alley,num,floor };
}

/* å…±ç”¨ï¼šè¼ªè©¢ /api/jobs/:id â†’ ä¸­æ–‡è¼¸å‡º */
async function pollJob(jobId, label){
  appendLog(`[poll] é–‹å§‹è¼ªè©¢ ${label}ï¼ˆjob=${jobId}ï¼‰...`);
  for(;;){
    await sleep(1500);
    let j=null;
    try{ j = await GET('/api/jobs/'+jobId); }catch{ /* ignore */ }
    if(!j){ appendLog('æŸ¥ç„¡æ­¤ä»»å‹™ï¼ˆå¯èƒ½å·²æ¸…é™¤ï¼‰'); return; }

    if(j.status==='done'){
      appendLog('ã€å®Œæˆã€‘');
      const r = j.result || {};
      if(typeof r === 'string'){ appendLog(r); return; }
      // ä»¥ä¸­æ–‡æ¬„ä½è¼¸å‡ºï¼ˆåœ°è™Ÿï¼å»ºè™Ÿï¼å§”è¨—ï¼‰
      if(r.landNo || r.buildNoFull || r.entrust!==undefined){
        appendLog(`åœ°è™Ÿï¼š${r.landNo || ''}`);
        appendLog(`å»ºè™Ÿï¼š${r.buildNoFull || ''}`);
        if(r.entrust!==undefined) appendLog(`å§”è¨—ï¼š${r.entrust}`);
      }else{
        appendLog(r);
      }
      return;
    }
    if(j.status==='error'){
      appendLog(`ã€å¤±æ•—ã€‘${j.error || ''}`);
      return;
    }
    appendLog(`ç‹€æ…‹ï¼š${j.status} ...`);
  }
}

/* äº‹ä»¶ç¶å®š */
$('save').onclick = () => {
  state.api  = $('api').value;
  state.key  = $('key').value;
  state.mode = $('mode').value;
  appendLog('å·²å„²å­˜è¨­å®šã€‚');
};

$('ping').onclick = async () => {
  clearLog(); appendLog('æª¢æŸ¥å¥åº·ç‹€æ…‹...');
  setBadge($('healthStat'),'muted','æª¢æŸ¥ä¸­');
  try{
    const t = await fetch(base()+'/health').then(r=>r.text());
    appendLog(t.trim()==='OK' ? 'OK' : t);
    const cbs = await fetch(base()+'/api/check-cbs').then(r=>r.text()).catch(()=> 'å¤±æ•—');
    const bf  = await fetch(base()+'/api/check-bigfun').then(r=>r.text()).catch(()=> 'å¤±æ•—');
    appendLog('CBS ç™»å…¥ï¼š'+cbs);
    appendLog('BigFun ç™»å…¥ï¼š'+bf);
    setBadge($('healthStat'), (t.trim()==='OK' ? 'ok':'bad'), (t.trim()==='OK' ? 'OK':'å¤±æ•—'));
  }catch(e){
    appendLog('health å¤±æ•—ï¼š'+e.message);
    setBadge($('healthStat'),'bad','å¤±æ•—');
  }
};

$('echo').onclick = async () => {
  clearLog(); appendLog('Echo æ¸¬è©¦ä¸­...');
  const addr = $('addr').value.trim();
  // ç™»å…¥æ¢é‡
  try{
    const cbs = await fetch(base()+'/api/check-cbs').then(r=>r.text()).catch(()=> 'å¤±æ•—');
    const bf  = await fetch(base()+'/api/check-bigfun').then(r=>r.text()).catch(()=> 'å¤±æ•—');
    appendLog('CBS ç™»å…¥ï¼š'+cbs);
    appendLog('BigFun ç™»å…¥ï¼š'+bf);
  }catch(e){ appendLog('æ¢é‡éŒ¯èª¤ï¼š'+e.message); }

  // è¼•é‡åœ°å€è§£æï¼ˆä¸ç™¼é•·ä»»å‹™ï¼Œè®“ Echo æ°¸é ç§’å›ï¼‰
  const p = parseTaiwanAddress(addr);
  appendLog('åœ°å€è§£æï¼š'+JSON.stringify(p));
};

$('runBigfun').onclick = async () => {
  clearLog(); appendLog('åŸ·è¡Œ BigFun...');
  try{
    const resp = await POST('/api/run-bigfun', { address:$('addr').value.trim() });
    appendLog(`[job] ${resp.jobId || resp.taskId || '(ç„¡ç·¨è™Ÿ)'} å»ºç«‹ï¼Œé–‹å§‹è¼ªè©¢...`);
    await pollJob(resp.jobId || resp.taskId, 'BigFun');
  }catch(e){ appendLog('ç™¼èµ·å¤±æ•—ï¼š'+e.message); }
};

$('runCombo').onclick = async () => {
  clearLog(); appendLog('åŸ·è¡Œ Combo...');
  try{
    const resp = await POST('/api/run-combo', {
      address: $('addr').value.trim(),
      mode:    state.mode,
      verify:  '',
      lineOfficial: false
    });
    appendLog(`[job] ${resp.jobId || resp.taskId || '(ç„¡ç·¨è™Ÿ)'} å»ºç«‹ï¼Œé–‹å§‹è¼ªè©¢...`);
    await pollJob(resp.jobId || resp.taskId, 'Combo');
  }catch(e){ appendLog('ç™¼èµ·å¤±æ•—ï¼š'+e.message); }
};

$('abort').onclick = () => appendLog('ï¼ˆæ”¹ç‚ºèƒŒæ™¯ä»»å‹™ï¼Œä¸æä¾›ä¸­æ­¢ï¼‰');
</script>
</body>
</html>
