<!DOCTYPE html>
<html lang="zh-Hant" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>æˆ¿ä»²å§”è¨—æŸ¥è©¢å¹³å° v1.0</title>
<link rel="icon" href="./logo.png"/>

<style>
/* â€”â€” é€™è£¡å…¨éƒ¨ä¿æŒåŸæœ¬ â€”â€” */
...ã€ä½ çš„ CSS å…¨éƒ¨ä¿ç•™ï¼Œä¸å‹•ã€‘...
</style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div class="brand">
      <h1>
        <img src="./logo.png" style="width:40px;height:40px;border-radius:4px;vertical-align:middle;margin-left:14px;">
        å§”è¨—æŸ¥è©¢
      </h1>
    </div>
    <div class="hdr-controls">
      <button id="musicToggle" class="btn-pill" style="color: var(--text);">ğŸ”Š BGMéŸ³æ¨‚</button>
      <button id="themeToggle" class="theme-toggle">ğŸŒ“ BGä¸»é¡Œ</button>
    </div>
  </div>

  <div class="card">
    <div class="grid2">
      <label>API Base</label><input id="api" placeholder="https://xxx.onrender.com"/>
      <label>X-API-KEY</label><input id="key" placeholder="å¯ç•™ç™½"/>
      <label>æ¨¡å¼</label>
      <select id="mode"><option value="exact">exact</option><option value="fuzzy">fuzzy</option></select>
    </div>
    <div class="btn-row" style="margin-top:12px">
      <button class="btn-primary" id="boot">ğŸª« SYSå•Ÿå‹•</button>
      <button class="btn-ghost" id="save">ğŸ’¾ SAVEå„²å­˜</button>
      <a class="btn-line" href="line://ti/p/@307momvl" target="_blank" rel="noopener">ğŸ’¬ LINEå®˜æ–¹</a>
      <span></span>
    </div>
  </div>

  <div class="card">
    <div class="grid2"><label>æŸ¥è©¢åœ°å€</label><input id="addr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚å—å±¯å€å¤§å¢©å—è·¯356è™Ÿ"/></div>
    <div class="btn-row">
      <button class="btn-primary" id="echo">æ¸¬è©¦ Echo</button>
      <button class="btn-info" id="runCombo">åŸ·è¡Œ Combo</button>
      <button class="btn-stop" id="runBigfun">åƒ… BigFun</button>
      <button class="btn-close" id="abort" disabled>ä¸­æ­¢ Stop</button>
    </div>
    <label style="display:block;margin-top:12px;font-weight:800">æ—¥èªŒè¼¸å‡º</label>
    <textarea id="log" class="log" spellcheck="false"></textarea>
  </div>
</div>

<audio id="bgm" loop src="https://www.christourlife.ca/images/music/instrumental-hymns-cd/03%20Be%20Still%20My%20Soul.mp3"></audio>
<div id="overlay" class="overlay" style="display:none">
  <div class="spinner"></div>
  <div class="overlay-msg">ğŸ§  æ™ºæ…§é€£ç·šä¸­ï¼Œè«‹ç¨å€™â€¦</div>
</div>

<script>
/* ------------------------------------------
   âœ… DOM Helpers
-------------------------------------------*/
const $=id=>document.getElementById(id);

/* âœ… å„ªåŒ–å¾Œ UI Logï¼šåªç•™ä¸€è¡Œä¸” 200 å­—å…§ã€å‰ HTML */
function uiLog(msg){
  const s = String(msg).replace(/<[^>]*>/g,'');
  const line = s.split('\n')[0].slice(0,200);
  const ta = $('log');
  ta.value += line + "\n";
  ta.scrollTop = ta.scrollHeight;
}
function clearLog(){ $('log').value=''; }

/* âœ… éŒ¯èª¤è¨Šæ¯ç¿»è­¯ */
function friendly(e){
  const s = String(e);
  if(s.includes('401')) return 'âŒ æœªæˆæ¬Šï¼ˆéœ€è¦ API KEYï¼‰';
  if(s.includes('404')) return 'âŒ æœå‹™ä¸å­˜åœ¨ / API Base éŒ¯èª¤';
  if(s.includes('timeout')) return 'â³ é€£ç·šè¶…æ™‚';
  return 'âŒ ' + s.replace(/<[^>]+>/g,'');
}

/* âœ… fetch åŒ…è£ï¼šè‡ªå‹•ç²¾ç°¡éŒ¯èª¤ æ—¥èªŒ */
async function http(url, opts = {}){
  const res = await fetch(url, opts).catch(err=>{
    uiLog(friendly(err));
    throw err;
  });

  if(!res.ok){
    uiLog(`âŒ [upstream ${res.status}]`);
    throw new Error(`HTTP ${res.status}`);
  }

  try{ return await res.json(); }
  catch{ return await res.text(); }
}

/* âœ… å°ˆé–€é¡¯ç¤º SYS å•Ÿå‹•æ¢é‡çµæœ */
function logProbe(probe){
  const brief = {
    ok: probe?.ok === true,
    render: probe?.render,
    upstream: { ok: probe?.upstream?.ok, status: probe?.upstream?.status },
    tunnel: probe?.tunnel
  };
  uiLog(`ğŸ’¡ ${JSON.stringify(brief)}`);
}

/* ------------------------------------------
   âœ… LocalState
-------------------------------------------*/
const state={
  get api(){return localStorage.getItem('api')||''},set api(v){localStorage.setItem('api',v||'')},
  get key(){return localStorage.getItem('key')||''},set key(v){localStorage.setItem('key',v||'')},
  get mode(){return localStorage.getItem('mode')||'exact'},set mode(v){localStorage.setItem('mode',v)},
  get theme(){return localStorage.getItem('theme')||'light'},set theme(v){localStorage.setItem('theme',v)},
  get music(){return localStorage.getItem('music')||'on'},set music(v){localStorage.setItem('music',v)}
};

function headers(){
  const h={'Content-Type':'application/json'};
  const k=state.key?.trim();
  if(k)h['x-api-key']=k;
  return h;
}

/* ------------------------------------------
   âœ… SYS BOOT
-------------------------------------------*/
$('boot').onclick = async()=>{
  clearLog();
  $('overlay').style.display='flex';

  const base = (state.api||'').replace(/\/$/,'');
  try{
    const h = await fetch(base+'/health').then(r=>r.json()).catch(e=>({error:String(e)}));
    logProbe(h);

    const warm = await fetch(base+'/api/start-all',{method:'POST',headers:headers()})
      .then(r=>r.json())
      .catch(e=>({ok:false,error:String(e)}));

    uiLog(`ğŸ§  å•Ÿå‹•ï¼š${warm.ok?'OK':'FAIL'}`);
    uiLog(`ğŸŒ ç³»çµ±å°±ç·’`);
  } catch(e){
    uiLog(friendly(e));
  }

  setTimeout(()=>$('overlay').style.display='none',600);
};

/* ------------------------------------------
   âœ… Echo / Combo / BigFun
-------------------------------------------*/
async function post(p, body){
  const url = (state.api||'').replace(/\/$/,'') + p;
  return http(url, {method:'POST', headers:headers(), body:JSON.stringify(body)});
}

async function get(p){
  const url = (state.api||'').replace(/\/$/,'') + p;
  return http(url, {headers:headers()});
}

$('echo').onclick = async()=>{
  clearLog();
  try{
    uiLog(`CBSï¼š${await get('/api/check-cbs')}`);
    uiLog(`BigFunï¼š${await get('/api/check-bigfun')}`);
  } catch(e){ uiLog(friendly(e)); }
};

async function pollJob(id,label){
  uiLog(`ä»»å‹™å»ºç«‹ï¼š${id}`);
  for(;;){
    await new Promise(r=>setTimeout(r,1500));
    let j = await http((state.api||'').replace(/\/$/,'')+'/api/jobs/'+id,{headers:headers()}).catch(()=>null);
    if(!j) return uiLog('ä»»å‹™ä¸å­˜åœ¨');
    if(j.status==='done') return uiLog(`âœ… å®Œæˆ`);
    if(j.status==='error') return uiLog(`å¤±æ•—ï¼š${j.error}`);
    uiLog('â€¦è™•ç†ä¸­');
  }
}

$('runBigfun').onclick = async()=>{
  clearLog();
  try{ let r = await post('/api/run-bigfun',{address:$('addr').value.trim()}); await pollJob(r.jobId,'BigFun'); }
  catch(e){ uiLog(friendly(e)); }
};

$('runCombo').onclick = async()=>{
  clearLog();
  try{ let r = await post('/api/run-combo',{address:$('addr').value.trim(),mode:state.mode}); await pollJob(r.jobId,'Combo'); }
  catch(e){ uiLog(friendly(e)); }
};

/* ------------------------------------------
   âœ… UI / è¨­å®š / BGM (åŸæœ¬çš„éƒ½ä¿ç•™)
-------------------------------------------*/
...ã€éŸ³æ¨‚ã€å„²å­˜ã€Theme Toggle ç­‰åŸæœ¬ç¨‹å¼å…¨éƒ¨ä¿ç•™ã€‘...

</script>
</body>
</html>
