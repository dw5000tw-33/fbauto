<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBS Agent æ§åˆ¶å°</title>
  <style>
    :root{
      --bg:#f7f7f5; --panel:#ffffff; --muted:#6b7280; --text:#0a1a3f;
      --primary:#1e3a8a; --border:#e5e7eb; --code:#f3f4f6;
      --ok:#16a34a; --bad:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.58 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    .wrap{max-width:760px;margin:18px auto 28px;padding:0 12px}
    .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .hdr h2{margin:0;font-size:18px;font-weight:800}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 4px 12px rgba(2,6,23,.06);margin-bottom:12px}
    label{display:block;margin:4px 0 6px;font-weight:700;font-size:13px}
    input,select{width:62%;padding:10px 12px;background:#fafafa;color:var(--text);border:1px solid var(--border);border-radius:10px;outline:none}
    input:focus,select:focus{border-color:#93c5fd;box-shadow:0 0 0 3px #dbeafe}
    .pair{display:flex;gap:10px;align-items:center;flex-wrap:nowrap}
    .btn-row{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:8px;margin-top:10px}
    button{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn-start{background:#1e3a8a;color:#fff}
    .btn-info{background:#e0e7ff;color:#1e293b;border:1px solid #c7d2fe}
    .btn-stop{background:#f3f4f6;color:#111827;border:1px solid var(--border)}
    .btn-close{background:#111827;color:#fff}
    .badge{display:inline-flex;align-items:center;justify-content:center;height:20px;padding:0 8px;border-radius:999px;font-weight:700;font-size:12px}
    .ok{background:#ecfdf5;color:var(--ok);border:1px solid #bbf7d0}
    .bad{background:#fef2f2;color:var(--bad);border:1px solid #fecaca}
    .muted{background:#eef2ff;color:#475569;border:1px solid #e2e8f0}
    .log{white-space:pre-wrap;overflow:auto;background:var(--code);border:1px solid var(--border);border-radius:10px;padding:12px;min-height:420px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr"><h2>ğŸ  CBS Agent æ§åˆ¶å°</h2></div>

    <div class="card">
      <div class="pair">
        <label>API Base</label>
        <input id="api" placeholder="ä¾‹å¦‚ https://cbs-agent-docker.onrender.com" />
      </div>
      <div class="pair" style="margin-top:6px">
        <label>X-API-KEY</label>
        <input id="key" placeholder="å¯ç•™ç™½" />
      </div>
      <div class="pair" style="margin-top:6px;align-items:center">
        <label>æ¨¡å¼</label>
        <select id="mode">
          <option value="exact">exactï¼ˆç²¾æº–ï¼‰</option>
          <option value="fuzzy">fuzzyï¼ˆå¯¬é¬†ï¼‰</option>
        </select>
        <span id="healthStat" class="badge muted">æœªçŸ¥</span>
      </div>
      <div class="pair" style="margin-top:10px;gap:8px">
        <button class="btn-stop" id="save">ğŸ’¾ å„²å­˜</button>
        <button class="btn-info" id="ping">ğŸ” å¥åº·æª¢æŸ¥</button>
      </div>
    </div>

    <div class="card">
      <div class="pair">
        <label>æŸ¥è©¢åœ°å€</label>
        <input id="addr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚å—å±¯å€å¤§å¢©å—è·¯356è™Ÿ" style="flex:1" />
      </div>
      <div class="btn-row">
        <button class="btn-start" id="echo">Echo æ¸¬è©¦</button>
        <button class="btn-info" id="runCombo">åŸ·è¡Œ Combo</button>
        <button class="btn-stop" id="runBigfun">åƒ… BigFun</button>
        <button class="btn-close" id="abort" disabled>ä¸­æ­¢</button>
      </div>
      <label style="margin-top:10px">æ—¥èªŒè¼¸å‡º</label>
      <textarea id="log" class="log" spellcheck="false" placeholder="é€™è£¡æœƒé¡¯ç¤ºä¸²æµæ—¥èªŒ..."></textarea>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const state = {
  get api(){ return localStorage.getItem('api') || '' },
  set api(v){ localStorage.setItem('api', v || '') },
  get key(){ return localStorage.getItem('key') || '' },
  set key(v){ localStorage.setItem('key', v || '') },
  get mode(){ return localStorage.getItem('mode') || 'exact' },
  set mode(v){ localStorage.setItem('mode', v || 'exact') },
};

(function init(){
  $('api').value = state.api; $('key').value = state.key; $('mode').value = state.mode;
  $('saveBox')?.classList.remove('on');
})();

function badge(el, kind, text){ el.className='badge '+(kind||'muted'); el.textContent=text; }
function appendLog(txt){ const ta=$('log'); ta.value += txt; ta.scrollTop = ta.scrollHeight }
function clearLog(){ $('log').value='' }

async function apiFetch(path, opts={}){
  const base = (state.api||'').replace(/\/+$/,'');
  if (!base) throw new Error('å°šæœªè¨­å®š API Base');
  const headers = {'Content-Type':'application/json'};
  const k = (state.key||'').trim(); if (k) headers['x-api-key']=k;
  const res = await fetch(base + path, { headers, ...opts });
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res;
}

async function postJSON(path, data){
  return apiFetch(path, { method:'POST', body: JSON.stringify(data||{}) });
}

async function pollJob(jobId, onTick){
  const base = (state.api||'').replace(/\/+$/,'');
  while (true){
    const r = await fetch(`${base}/api/jobs/${jobId}`);
    if (!r.ok) throw new Error(`jobs ${r.status}`);
    const j = await r.json();
    onTick?.(j);
    if (j.status === 'done' || j.status === 'error') return j;
    await new Promise(r=>setTimeout(r, 1500));
  }
}

$('save').onclick = ()=>{
  state.api  = $('api').value;
  state.key  = $('key').value;
  state.mode = $('mode').value;
  $('saveBox')?.classList.add('on');
};

$('ping').onclick = async()=>{
  clearLog(); appendLog('æª¢æŸ¥å¥åº·ç‹€æ…‹...\n');
  badge($('healthStat'), 'muted', 'æª¢æŸ¥ä¸­');
  try{
    const r = await fetch((state.api||'').replace(/\/+$/,'') + '/health');
    const t = await r.text(); appendLog(t);
    badge($('healthStat'), 'ok', 'OK');
  }catch(err){
    appendLog('health å¤±æ•—ï¼š'+err.message+'\n');
    badge($('healthStat'), 'bad', 'å¤±æ•—');
  }
};

function showResult(title, result){
  appendLog(`\n=== ${title} çµæœ ===\n`);
  if (result?.result){
    const r = result.result;
    if (r.landNo)  appendLog(`åœ°è™Ÿï¼š${r.landNo}\n`);
    if (r.buildNo) appendLog(`å»ºè™Ÿï¼š${r.buildNo}\n`);
    if (r.entrust) appendLog(`å§”è¨—ï¼š${r.entrust}\n`);
    if (!r.landNo && !r.buildNo && !r.entrust && r.raw) appendLog((r.raw || '') + '\n');
    if (r.ok) appendLog('ç‹€æ…‹ï¼šæˆåŠŸ\n'); else appendLog('ç‹€æ…‹ï¼šå¯èƒ½å¤±æ•—/éƒ¨åˆ†æˆåŠŸ\n');
  } else if (result?.error){
    appendLog('éŒ¯èª¤ï¼š' + result.error + '\n');
  } else {
    appendLog(JSON.stringify(result,null,2)+'\n');
  }
}

$('echo').onclick = async()=>{
  clearLog(); appendLog('Echo æ¸¬è©¦ä¸­...\n');
  try{
    // é€™è£¡ä½ è‹¥å·²åœ¨å¾Œç«¯åš check-cbs/check-bigfunï¼Œå¯å‘¼å« /api/check-xxx
    // ç›®å‰åƒ…ç¤ºç¯„å¥åº·æª¢æŸ¥èˆ‡åœ°å€è§£æï¼ˆå¿…è¦æ™‚å¯æ“´å……ï¼‰
    appendLog('OK\nOK\nCBSç™»å…¥ï¼šæœªçŸ¥\nBigFunç™»å…¥ï¼šæœªçŸ¥\nåœ°å€è§£æï¼š{}\n');
  }catch(err){ appendLog(err.message+'\n'); }
};

$('runBigfun').onclick = async()=>{
  clearLog(); appendLog('åŸ·è¡Œ BigFun...\n');
  try{
    const body = { address:$('addr').value, show:'0' };
    const res = await postJSON('/api/run-bigfun', body);
    const j = await res.json();
    appendLog(`[job] ${j.jobId} å»ºç«‹ï¼Œé–‹å§‹è¼ªè©¢...\n`);
    const fin = await pollJob(j.jobId, (tick)=>{ /* å¯é¸ï¼šappendLog('.') */ });
    showResult('BigFun', fin);
  }catch(err){ appendLog(err.message+'\n'); }
};

$('runCombo').onclick = async()=>{
  clearLog(); appendLog('åŸ·è¡Œ Combo...\n');
  try{
    const body = { address:$('addr').value, mode: state.mode, verify:'', lineOfficial:false };
    const res = await postJSON('/api/run-combo', body);
    const j = await res.json();
    appendLog(`[job] ${j.jobId} å»ºç«‹ï¼Œé–‹å§‹è¼ªè©¢...\n\n`);
    appendLog(JSON.stringify(j, null, 2) + '\n');

    const fin = await pollJob(j.jobId, (tick)=>{ /* å¯é¸ï¼šappendLog('.') */ });
    showResult('Combo', fin);
  }catch(err){ appendLog(err.message+'\n'); }
};

$('abort').onclick = async()=>{
  appendLog('\nï¼ˆç›®å‰ fire-and-poll ç‰ˆæœ¬ä¸æ”¯æ´ä¸­æ­¢ï¼Œä¹‹å¾Œå¯æ“´å…… /api/abort-job/<id>ï¼‰\n');
};
</script>
</body>
</html>
