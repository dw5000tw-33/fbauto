<!DOCTYPE html>
<html lang="zh-Hant" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ¿ä»²å§”è¨—æŸ¥è©¢å¹³å° v1.0</title>
  <link rel="icon" href="./logo.png" />
  <style>
/* ---- ä½ çš„ CSS åŸå°ä¸å‹•ä¿ç•™ ---- */
:root{
  --bg:#f7f7f5;--panel:#ffffff;--text:#0a1a3f;--muted:#6b7280;--border:#e5e7eb;--code:#f3f4f6;
  --primary:#1e3a8a;--ok:#16a34a;--bad:#dc2626;--warn:#a16207;--btn:#1e3a8a;--btn-ink:#ffffff;
  --input-bg:#ffffff;--log-ink:#1f2937;
}
html[data-theme="dark"]{--bg:#0b0f14;--panel:#11161d;--text:#e6edf3;--muted:#94a3b8;--border:#263241;--code:#0f1720;
  --primary:#60a5fa;--ok:#22c55e;--bad:#ef4444;--warn:#f59e0b;--btn:#60a5fa;--btn-ink:#0b1220;
  --input-bg:#0f141b;--log-ink:#e5e7eb;}
/* ...ï¼ˆCSS å…¨éƒ¨ä¿ç•™ï¼‰... */
  </style>
</head>

<body>
<div class="wrap">
  <div class="hdr">
    <div class="brand">
      <h1><img src="./logo.png" style="width:40px;height:40px;border-radius:4px;margin-left:14px;">å§”è¨—æŸ¥è©¢</h1>
    </div>
    <div class="hdr-controls">
      <button id="musicToggle" class="btn-pill">ğŸ”Š BGMéŸ³æ¨‚</button>
      <button id="themeToggle" class="theme-toggle">ğŸŒ“ BGä¸»é¡Œ</button>
    </div>
  </div>

  <div class="card">
    <div class="grid2">
      <label>API Base</label><input id="api" placeholder="https://xxx.onrender.com"/>
      <label>X-API-KEY</label><input id="key" placeholder="å¯ç•™ç™½"/>
      <label>æ¨¡å¼</label>
      <select id="mode"><option value="exact">exact</option><option value="fuzzy">fuzzy</option></select>
    </div>
    <div class="btn-row" style="margin-top:12px">
      <button class="btn-primary" id="boot">ğŸª« SYSå•Ÿå‹•</button>
      <button class="btn-ghost" id="save">ğŸ’¾ SAVEå„²å­˜</button>
      <a class="btn-line" href="line://ti/p/@307momvl" target="_blank">ğŸ’¬ LINEå®˜æ–¹</a>
      <span></span>
    </div>
  </div>

  <div class="card">
    <div class="grid2"><label>æŸ¥è©¢åœ°å€</label><input id="addr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚å—å±¯å€å¤§å¢©å—è·¯356è™Ÿ"/></div>
    <div class="btn-row">
      <button class="btn-primary" id="echo">æ¸¬è©¦ Echo</button>
      <button class="btn-info" id="runCombo">åŸ·è¡Œ Combo</button>
      <button class="btn-stop" id="runBigfun">åƒ… BigFun</button>
      <button class="btn-close" id="abort" disabled>ä¸­æ­¢ Stop</button>
    </div>
    <label style="margin-top:12px;font-weight:800">æ—¥èªŒè¼¸å‡º</label>
    <textarea id="log" class="log" spellcheck="false" placeholder="é€™è£¡æœƒé¡¯ç¤ºä¸²æµæ—¥èªŒ..."></textarea>
  </div>
</div>

<audio id="bgm" loop src="https://www.christourlife.ca/images/music/instrumental-hymns-cd/03%20Be%20Still%20My%20Soul.mp3"></audio>

<div id="overlay" class="overlay" style="display:none">
  <div class="spinner"></div>
  <div class="overlay-msg">ğŸ§  æ™ºæ…§é€£ç·šä¸­ï¼Œè«‹ç¨å€™â€¦</div>
</div>

<script>
/* ---- UI helpers ---- */
const $=id=>document.getElementById(id);
function uiLog(msg){
  const s=typeof msg==='object'?JSON.stringify(msg):String(msg);
  $('log').value+=s+"\n"; $('log').scrollTop=$('log').scrollHeight;
}
function clearLog(){ $('log').value=''; }
function friendly(err){ const s=String(err); if(s.includes('401')) return 'âŒ æœªæˆæ¬Š'; if(s.includes('404')) return 'âŒ APIéŒ¯èª¤'; if(s.includes('timeout')) return 'â³ è¶…æ™‚'; return 'âŒ '+s; }

/* ---- Local state & headers ---- */
const state={get api(){return localStorage.api||''},set api(v){localStorage.api=v},
  get key(){return localStorage.key||''},set key(v){localStorage.key=v},
  get mode(){return localStorage.mode||'exact'},set mode(v){localStorage.mode=v},
  get theme(){return localStorage.theme||'light'},set theme(v){localStorage.theme=v},
  get music(){return localStorage.music||'on'},set music(v){localStorage.music=v}};
function headers(){const h={'Content-Type':'application/json'};if(state.key)h['x-api-key']=state.key;return h;}

/* ---- Fetch wrapper ---- */
async function http(url,opts={}){const res=await fetch(url,opts).catch(e=>{uiLog(friendly(e));throw e});const raw=await res.text();try{return JSON.parse(raw)}catch{return raw}}

/* ---- Theme & Music ---- */
$('themeToggle').onclick=()=>{state.theme=state.theme==='light'?'dark':'light';document.documentElement.setAttribute('data-theme',state.theme)};
const bgm=$('bgm');$('musicToggle').onclick=()=>{bgm.paused?bgm.play():bgm.pause()};

/* ---- Boot ---- */
$('boot').onclick=async()=>{clearLog();
  const base=state.api.replace(/\/$/,'');
  const h=await fetch(base+'/health').then(r=>r.json()).catch(e=>({error:e}));
  uiLog('ğŸŒ Health: '+JSON.stringify(h));
  const w=await fetch(base+'/api/start-all',{method:'POST',headers:headers()}).then(r=>r.json()).catch(e=>({error:e}));
  uiLog('ğŸ§  å•Ÿå‹•: '+JSON.stringify(w));
};

/* ---- API wrappers ---- */
async function post(p,b){return http(state.api.replace(/\/$/,'')+p,{method:'POST',headers:headers(),body:JSON.stringify(b)})}
async function get(p){return http(state.api.replace(/\/$/,'')+p,{headers:headers()})}

/* ---- Echo ---- */
$('echo').onclick=async()=>{clearLog();uiLog('Echo æ¸¬è©¦');
  uiLog('CBS: '+await get('/api/check-cbs'));uiLog('BigFun: '+await get('/api/check-bigfun'));uiLog('âœ… å®Œæˆ');
};

/* âœ… ---- ä¿®æ­£ç‰ˆ pollJob (é‡é») ---- */
async function pollJob(id,label){
  uiLog(`ï¼»${label}ï¼½ä»»å‹™å»ºç«‹ï¼š${id}`);
  for(;;){
    await new Promise(r=>setTimeout(r,1000));
    const j=await http(state.api.replace(/\/$/,'')+'/api/jobs/'+id,{headers:headers()}).catch(()=>null);
    if(!j){uiLog('â“ ä»»å‹™ä¸å­˜åœ¨');return;}

    if(j.landNo){uiLog(`ğŸ“ åœ°è™Ÿï¼š${j.landNo}`);}
    if(j.buildNoFull){uiLog(`ğŸ¢ å»ºè™Ÿï¼š${j.buildNoFull}`);}

    if(j.phase==='bigfun'){uiLog('ğŸ” BigFun æŸ¥è©¢ä¸­â€¦');}
    else if(j.phase==='merge'){uiLog('ğŸ§© å·²å–å¾—åœ°è™Ÿ/å»ºè™Ÿ â†’ é€²å…¥ CBS');}

    if(j.status==='error'){uiLog('âŒ éŒ¯èª¤ï¼š'+j.error);return;}
    if(j.status==='done'){
      if(j.result?.entrust){uiLog(`ğŸ“‘ å§”è¨—ç‹€æ…‹ï¼š${j.result.entrust}`);}
      uiLog('âœ… å®Œæˆ');return;
    }

    uiLog('â€¦è™•ç†ä¸­');
  }
}

/* ---- Run Bigfun ---- */
$('runBigfun').onclick=async()=>{clearLog();
  const r=await post('/api/run-bigfun',{address:$('addr').value.trim()});
  await pollJob(r.jobId,'BigFun');
};

/* ---- Run Combo (å…©æ®µå¼) ---- */
$('runCombo').onclick=async()=>{clearLog();
  const r=await post('/api/run-combo',{address:$('addr').value.trim(),mode:state.mode});
  await pollJob(r.jobId,'Combo');
};
</script>
</body>
</html>
