<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBS Agent æ§åˆ¶å°</title>
<style>
  /* ========= THEME: æƒ³æ”¹é…è‰²åªèª¿é€™è£¡ ========= */
  :root{
    --bg:#f8f7f4;           /* ä¹³ç™½åº• */
    --panel:#ffffff;        /* å¡ç‰‡ç™½ */
    --muted:#6b7280;        /* æ¬¡è¦å­— */
    --text:#0a1a3f;         /* æ·±æµ·è—æ–‡å­— */
    --primary:#1d4ed8;      /* å¸Œè‡˜æµ·è— */
    --primary-ink:#ffffff;  /* ä¸»è‰²ä¸Šçš„ç™½å­— */
    --danger:#000000;       /* éŒ¯èª¤ */
    --ok:#059669;           /* æˆåŠŸ */
    --border:#dce3f0;       /* æ·¡è—ç°é‚Šæ¡† */
    --code:#f1f5f9;         /* æ—¥èªŒ/ä»£ç¢¼ï¼šæ·ºéœ§è—ç°ï¼ˆäº®ï¼‰ */
  }

  @media (prefers-color-scheme: light){
    /* ä¿æŒäº®ç³»ï¼Œä¸è¦è¦†è“‹æˆæ·±è‰² */
    :root{ --bg:#f6f7fb; --panel:#ffffff; --text:#0a1a3f; --muted:#6b7280; --border:#e5e7eb; --code:#eef2f7; }
  }

  *{ box-sizing:border-box }
  body{
    margin:0;
    font:14px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
    background:var(--bg);
    color:var(--text);
  }
  .wrap{ max-width:960px; margin:32px auto; padding:0 16px; }
  h1{ font-size:22px; margin:0 0 16px; letter-spacing:.5px }

  /* å¡ç‰‡ï¼šæ›´è¼•çš„é™°å½± */
  .card{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:14px;
    padding:18px;
    box-shadow:0 4px 16px rgba(2,6,23,.08);
  }

  .row{ display:flex; gap:12px; flex-wrap:wrap }
  .col{ flex:1 1 260px }
  label{ display:block; font-weight:600; color:var(--muted); margin-bottom:6px }

  /* è¼¸å…¥å…ƒä»¶ï¼šäº®åº• */
  input,select,textarea{
    width:100%;
    padding:10px 12px;
    background:#f9fafb;            /* ç”±åŸæœ¬æ·±è‰² #0b1326 æ”¹ç‚ºäº®åº• */
    color:var(--text);
    border:1px solid var(--border);
    border-radius:10px;
    outline:none;
    transition:.2s ease;
  }
  input::placeholder{ color:#6b728088 }
  textarea{
    min-height:220px;
    font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    background:var(--code);        /* ä½¿ç”¨äº®è‰²ä»£ç¢¼åº• */
  }
  input:focus,select:focus,textarea:focus{
    border-color:var(--primary);
    box-shadow:0 0 0 2px rgba(29,78,216,.15);
  }

  .btns{ display:flex; gap:10px; flex-wrap:wrap }

  /* ä¸»è¦æŒ‰éˆ•ï¼šè— */
  button{
    appearance:none;
    border:none;
    border-radius:10px;
    padding:10px 14px;
    font-weight:700;
    cursor:pointer;
    background:var(--primary);
    color:var(--primary-ink);
    box-shadow:0 6px 18px rgba(29,78,216,.20); /* ç”±é’è‰²æ”¹ç‚ºä¸»è— */
    transition:.2s ease;
  }
  button:hover{ background:#2563eb }
  button:active{ transform:translateY(1px) }
  button:disabled{ background:#cbd5e1; color:#475569; box-shadow:none }

  /* æ¬¡è¦æŒ‰éˆ•ï¼šäº®ç³»é‚Šæ¡†ï¼Œä¸å†ç”¨æ·±åº• */
  button.secondary{
    background:#eef2ff;             /* æ·¡é›ç´«äº®åº• */
    color:#1e293b;
    border:1px solid var(--border);
    box-shadow:none;
  }
  button.secondary:hover{ background:#e0e7ff }

  button.danger{ background:var(--danger); color:#fff }

  small.help{ color:var(--muted); display:block; margin-top:6px }

  /* ç‹€æ…‹ Pillï¼šäº®åº• */
  .pill{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#f3f6ff;             /* ç”±æ·±åº•æ”¹ç‚ºäº®åº• */
    color:#475569;
    font-size:12px;
  }

  .mt{ margin-top:12px }
  .mb{ margin-bottom:12px }

  /* æ—¥èªŒé¢æ¿ï¼šäº®ã€å¯è®€ */
  .log{
    width:100%;
    min-height:300px;
    white-space:pre-wrap;
    overflow:auto;
    background:var(--code);
    border:1px solid var(--border);
    border-radius:10px;
    padding:10px 12px;
  }

  .split{ display:grid; grid-template-columns:1.3fr .7fr; gap:16px }
  @media (max-width:900px){ .split{ grid-template-columns:1fr } }

  a{ color:var(--primary); text-decoration:none }
</style>

</head>
<body>
  <div class="wrap">
    <h1>ğŸ  CBS Agent æ§åˆ¶å°</h1>

    <div class="card mb">
      <div class="row">
        <div class="col">
          <label>API Baseï¼ˆRender / å…§ç¶²ç«¯é»ï¼‰</label>
          <input id="api" placeholder="ä¾‹å¦‚ https://cbs-agent-docker.onrender.com" />
          <small class="help">æœƒè‡ªå‹•å­˜åˆ° localStorageã€‚è‹¥æœ‰åä»£ï¼Œå¡«ä½ çš„å­ç¶²åŸŸï¼ˆä¾‹å¦‚ <code>https://api.company.com</code>ï¼‰ã€‚</small>
        </div>
        <div class="col">
          <label>X-API-KEYï¼ˆå¦‚æœ‰è¨­å®šï¼‰</label>
          <input id="key" placeholder="å¯ç•™ç™½" />
          <small class="help">è‹¥å¾Œç«¯æœ‰é–‹ <code>API_KEY</code>ï¼Œå‰ç«¯è«‹åœ¨æ­¤å¡«å…¥ã€‚</small>
        </div>
      </div>
      <div class="btns mt">
        <button id="save">ğŸ’¾ å„²å­˜é€£ç·šè¨­å®š</button>
        <button class="secondary" id="ping">ğŸ” å¥åº·æª¢æŸ¥ /health</button>
      </div>
    </div>

    <div class="split">
      <div class="card">
        <label>å®Œæ•´åœ°å€</label>
        <input id="addr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚å—å±¯å€å¤§å¢©å—è·¯356è™Ÿ" />
        <div class="row mt">
          <div class="col">
            <label>æ¨¡å¼</label>
            <select id="mode">
              <option value="exact">exact</option>
              <option value="fuzzy">fuzzy</option>
            </select>
          </div>
          <div class="col">
            <label>BigFun é©—è­‰</label>
            <select id="verify">
              <option value="">è‡ªå‹•</option>
              <option value="true">å¼·åˆ¶é©—è­‰</option>
              <option value="false">è·³éé©—è­‰</option>
            </select>
          </div>
        </div>
        <div class="btns mt">
          <button id="echo">ğŸ§ª Echo æ¸¬è©¦</button>
          <button id="runCombo">ğŸš€ åŸ·è¡Œ Comboï¼ˆCBS + BigFunï¼‰</button>
          <button id="runBigfun" class="secondary">ğŸ—ï¸ åƒ… BigFun</button>
          <button id="abort" class="danger">â›” ä¸­æ­¢</button>
        </div>
        <small class="help mt">æç¤ºï¼šRender å¾Œç«¯è‹¥é–‹å•Ÿä¸²æµï¼Œé€™è£¡æœƒå³æ™‚é¡¯ç¤ºæ—¥èªŒã€‚</small>
      </div>

      <div class="card">
        <div class="row">
          <span class="pill">ç‹€æ…‹ï¼š<span id="status">idle</span></span>
          <span class="pill">APIï¼š<span id="apiShow">â€”</span></span>
        </div>
        <label class="mt">æ—¥èªŒè¼¸å‡º</label>
        <textarea id="log" class="log" spellcheck="false" placeholder="é€™è£¡æœƒé¡¯ç¤ºä¸²æµæ—¥èªŒ..."></textarea>
      </div>
    </div>

    <div class="card mt">
      <b>èªªæ˜</b>
      <ol>
        <li>å…ˆåœ¨ä¸Šæ–¹è¨­å®š API Baseï¼ˆä½ çš„ Render/å…§ç¶² APIï¼‰ï¼Œå„²å­˜ã€‚</li>
        <li>æŒ‰ã€Œå¥åº·æª¢æŸ¥ã€æ‡‰å› <code>OK</code>ã€‚</li>
        <li>è¼¸å…¥å®Œæ•´åœ°å€ï¼›å…ˆé» Echo æ‡‰å›å‚³åŒä¸€åœ°å€ã€‚</li>
        <li>é»ã€Œåƒ… BigFunã€æˆ–ã€ŒComboã€è§€å¯Ÿæ—¥èªŒè¼¸å‡ºã€‚</li>
      </ol>
      <small class="help">å¦‚æœçœ‹åˆ° CORS éŒ¯èª¤ï¼Œè«‹ç¢ºèªå¾Œç«¯å·²é–‹ <code>cors({origin:true})</code> ä¸¦ä½¿ç”¨ HTTPSã€‚</small>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const state = {
      get api(){ return localStorage.getItem('api') || '' },
      set api(v){ localStorage.setItem('api', v || '') },
      get key(){ return localStorage.getItem('key') || '' },
      set key(v){ localStorage.setItem('key', v || '') },
    };

    function showConn(){
      $('api').value = state.api; $('key').value = state.key; $('apiShow').textContent = state.api || 'â€”';
    }
    showConn();

    function setStatus(s){ $('status').textContent = s }
    function appendLog(txt){ const ta=$('log'); ta.value += txt; ta.scrollTop = ta.scrollHeight }
    function clearLog(){ $('log').value=''}

    async function doFetch(path, opts={}){
      const base = state.api?.trim();
      if(!base) throw new Error('å°šæœªè¨­å®š API Base');
      const headers = {'Content-Type':'application/json'};
      const k = state.key?.trim(); if(k) headers['x-api-key']=k;
      const res = await fetch(base.replace(/\/$/, '') + path, { method:'POST', headers, ...opts });
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res;
    }

    $('save').onclick = ()=>{ state.api = $('api').value; state.key = $('key').value; showConn(); setStatus('saved') };
    $('ping').onclick  = async()=>{
      clearLog(); setStatus('checking');
      const base = state.api?.trim(); if(!base) return appendLog('å°šæœªè¨­å®š API Base');
      try{ const r = await fetch(base.replace(/\/$/, '') + '/health'); appendLog(await r.text()); setStatus('ok') }
      catch(err){ appendLog('health å¤±æ•—ï¼š'+err.message); setStatus('error') }
    };

    $('echo').onclick = async()=>{
      clearLog(); setStatus('echoâ€¦');
      try{
        const res = await doFetch('/api/echo-address', { body: JSON.stringify({ address:$('addr').value }) });
        appendLog(JSON.stringify(await res.json(), null, 2));
        setStatus('ok');
      }catch(err){ appendLog(err.message); setStatus('error') }
    };

    $('runBigfun').onclick = async()=>{
      clearLog(); setStatus('running');
      try{
        const res = await doFetch('/api/run-bigfun', { body: JSON.stringify({ address:$('addr').value, show:'0' }) });
        const reader = res.body.getReader(); const dec = new TextDecoder();
        while(true){ const {done, value} = await reader.read(); if(done) break; appendLog(dec.decode(value)) }
        setStatus('done');
      }catch(err){ appendLog(err.message); setStatus('error') }
    };

    $('runCombo').onclick = async()=>{
      clearLog(); setStatus('running');
      try{
        const res = await doFetch('/api/run-combo', { body: JSON.stringify({
          address: $('addr').value,
          mode: $('mode').value,
          verify: $('verify').value,
          lineOfficial: false
        })});
        const reader = res.body.getReader(); const dec = new TextDecoder();
        while(true){ const {done, value} = await reader.read(); if(done) break; appendLog(dec.decode(value)) }
        setStatus('done');
      }catch(err){ appendLog(err.message); setStatus('error') }
    };

    $('abort').onclick = async()=>{
      try{ const res = await doFetch('/api/abort', { body: JSON.stringify({}) }); appendLog('\n' + (await res.text())) }catch(err){ appendLog(err.message) }
    };
  </script>
</body>
</html>
