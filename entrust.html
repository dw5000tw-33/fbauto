<!DOCTYPE html>
<html lang="zh-Hant" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Œ£ Êàø‰ª≤ÂßîË®óÊü•Ë©¢Âπ≥Âè∞ v1.0</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext x='6' y='48' font-size='48'%3E%CF%83%3C/text%3E%3C/svg%3E" />
  <style>
    :root{
      --bg:#f7f7f5; --panel:#ffffff; --muted:#6b7280; --text:#0a1a3f;
      --primary:#1e3a8a; --border:#e5e7eb; --code:#f3f4f6;
      --ok:#16a34a; --bad:#dc2626; --warn:#a16207;
      --btn-ink:#fff; --btn:#1e3a8a;
    }
    html[data-theme="dark"]{
      --bg:#0b0c0f; --panel:#0f1115; --muted:#9aa0aa; --text:#e8ebf0;
      --primary:#8ab4ff; --border:#1c1f26; --code:#0c0e12;
      --ok:#34d399; --bad:#f87171; --warn:#f59e0b;
      --btn-ink:#0b0c0f; --btn:#8ab4ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.58 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    a{color:var(--primary);text-decoration:none}
    .wrap{max-width:860px;margin:20px auto 32px;padding:0 16px}
    .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#4f46e5, #06b6d4);display:grid;place-items:center;color:#fff;font-weight:900}
    .brand h1{margin:0;font-size:16px;font-weight:900;letter-spacing:.2px;display:flex;gap:8px;align-items:center}
    .hdr-tools{display:flex;align-items:center;gap:10px}
    .theme-toggle{appearance:none;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:700}
    .btn-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;border:1px solid var(--border);color:var(--text);background:var(--panel);font-weight:700}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 4px 12px rgba(2,6,23,.08);margin-bottom:12px}
    .grid2{display:grid;grid-template-columns:160px 1fr;gap:10px 12px;align-items:center}
    label{margin:0;font-weight:800;font-size:13px;color:var(--text)}
    input,select{width:100%;padding:10px 12px;background:transparent;color:var(--text);border:1px solid var(--border);border-radius:10px;outline:none}
    input:focus,select:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.25)}
    .btn-row{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:10px}
    button{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn-primary{background:var(--btn);color:var(--btn-ink)}
    .btn-info{background:#e0e7ff;color:#1e293b;border:1px solid #c7d2fe}
    html[data-theme="dark"] .btn-info{background:#111826;color:#9fb4ff;border-color:#273046}
    .btn-stop{background:#f3f4f6;color:#111827;border:1px solid var(--border)}
    html[data-theme="dark"] .btn-stop{background:#101318;color:#cdd3dd}
    .btn-close{background:#111827;color:#fff}
    .badge{display:inline-flex;align-items:center;justify-content:center;height:22px;padding:0 10px;border-radius:999px;font-weight:800;font-size:12px}
    .ok{background:#ecfdf5;color:var(--ok);border:1px solid #bbf7d0}
    .warn{background:#fffbeb;color:var(--warn);border:1px solid #fde68a}
    .bad{background:#fef2f2;color:var(--bad);border:1px solid #fecaca}
    .muted{background:#eef2ff;color:#475569;border:1px solid #e2e8f0}
    html[data-theme="dark"] .muted{background:#131722;color:#a0a7b4;border-color:#1f2430}
    .log{white-space:pre-wrap;overflow:auto;background:var(--code);border:1px solid var(--border);border-radius:10px;padding:12px;min-height:420px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}

    /* --- Loading Overlay (Apple-style) --- */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;z-index:9999;color:#e8ebf0}
    html[data-theme="light"] .overlay{background:#ffffff}
    .overlay .logo-big{width:68px;height:68px;border-radius:18px;background:linear-gradient(135deg,#4f46e5,#06b6d4);display:grid;place-items:center;color:#fff;font-weight:900;font-size:28px;box-shadow:0 10px 40px rgba(6,182,212,.35), 0 0 0 12px rgba(79,70,229,.12)}
    .spinner{width:38px;height:38px;border-radius:50%;border:3px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
    html[data-theme="light"] .spinner{border-color:rgba(0,0,0,.1);border-top-color:#0b0c0f}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Siri-like pulse */
    .pulse{position:relative;width:120px;height:24px;filter:blur(.2px)}
    .pulse::before,.pulse::after{
      content:"";position:absolute;inset:0;border-radius:999px;
      background:radial-gradient(ellipse at center, rgba(99,102,241,.85), transparent 55%),
                 radial-gradient(ellipse at 30% 50%, rgba(16,185,129,.85), transparent 55%),
                 radial-gradient(ellipse at 70% 50%, rgba(59,130,246,.85), transparent 55%);
      animation:pulse 2.4s ease-in-out infinite;
      mix-blend-mode:screen; opacity:.85;
    }
    .pulse::after{animation-delay:.8s;filter:blur(6px);opacity:.55}
    @keyframes pulse{
      0%{transform:scale(.85);opacity:.7}
      50%{transform:scale(1.06);opacity:1}
      100%{transform:scale(.85);opacity:.7}
    }
    .overlay-msg{font-weight:800;letter-spacing:.2px}
    html[data-theme="light"] .overlay{color:#0b0c0f}

    /* header audio & controls */
    .hdr-controls{display:flex;align-items:center;gap:10px}
    .audio{height:28px;display:inline-block}

    /* narrow */
    @media (max-width:640px){
      .grid2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Theme + Audio + Header -->
  <div class="wrap">
    <div class="hdr">
      <div class="brand">
        <button id="themeToggle" class="theme-toggle" title="ÂàáÊèõ‰∏ªÈ°å">üåì ‰∏ªÈ°å</button>
        <div class="logo">Œ£</div>
        <h1>Êàø‰ª≤ÂßîË®óÊü•Ë©¢Âπ≥Âè∞ v1.0</h1>
      </div>
      <div class="hdr-controls">
        <a class="btn-pill" href="https://line.me/R/ti/p/@your-line" target="_blank" rel="noopener">LINE ÂÆòÊñπ</a>
        <button id="musicToggle" class="btn-pill" title="Êí≠Êîæ/ÈùúÈü≥">üîä Èü≥Ê®Ç</button>
      </div>
    </div>

    <!-- Ë®≠ÂÆö -->
    <div class="card">
      <div class="grid2">
        <label>API Base</label>
        <input id="api" placeholder="‰æãÂ¶Ç https://cbs-agent-docker.onrender.com" />
        <label>X-API-KEY</label>
        <input id="key" placeholder="ÂèØÁïôÁôΩ" />
        <label>Ê®°Âºè</label>
        <select id="mode">
          <option value="exact">exactÔºàÁ≤æÊ∫ñÔºâ</option>
          <option value="fuzzy">fuzzyÔºàÂØ¨È¨ÜÔºâ</option>
        </select>
      </div>
      <div class="btn-row" style="margin-top:12px">
        <button class="btn-primary" id="boot">‚ö° ÂÖ®Á≥ªÁµ±ÂïüÂãï</button>
        <button class="btn-ghost" id="save">üíæ ÂÑ≤Â≠ò</button>
        <span></span><span></span>
      </div>
    </div>

    <!-- Êü•Ë©¢ -->
    <div class="card">
      <div class="grid2">
        <label>Êü•Ë©¢Âú∞ÂùÄ</label>
        <input id="addr" placeholder="‰æãÔºöÂè∞‰∏≠Â∏ÇÂçóÂ±ØÂçÄÂ§ßÂ¢©ÂçóË∑Ø356Ëôü" />
      </div>
      <div class="btn-row">
        <button class="btn-primary" id="echo">Echo Ê∏¨Ë©¶</button>
        <button class="btn-info" id="runCombo">Âü∑Ë°å Combo</button>
        <button class="btn-stop" id="runBigfun">ÂÉÖ BigFun</button>
        <button class="btn-close" id="abort" disabled>‰∏≠Ê≠¢</button>
      </div>

      <label style="display:block;margin-top:12px;font-weight:800">Êó•Ë™åËº∏Âá∫</label>
      <textarea id="log" class="log" spellcheck="false" placeholder="ÈÄôË£°ÊúÉÈ°ØÁ§∫‰∏≤ÊµÅÊó•Ë™å..."></textarea>
    </div>
  </div>

  <!-- Èü≥Ê®Ç -->
  <audio id="bgm" class="audio" preload="auto" loop
    src="https://www.christourlife.ca/images/music/instrumental-hymns-cd/03%20Be%20Still%20My%20Soul.mp3"></audio>

  <!-- Overlay -->
  <div id="overlay" class="overlay" style="display:none">
    <div class="logo-big">Œ£</div>
    <div class="spinner"></div>
    <div class="pulse"></div>
    <div class="overlay-msg">üß† Êô∫ÊÖßÈÄ£Á∑ö‰∏≠ÔºåË´ãÁ®çÂÄô‚Ä¶</div>
  </div>

<script>
/* ---------- State & Utils ---------- */
const $ = (id)=>document.getElementById(id);
function logLine(t){ const ta=$('log'); ta.value += (typeof t==='string'? t : JSON.stringify(t,null,2)) + '\n'; ta.scrollTop = ta.scrollHeight; }
function clearLog(){ $('log').value=''; }

const state = {
  get api(){ return localStorage.getItem('api') || '' },
  set api(v){ localStorage.setItem('api', v||'') },
  get key(){ return localStorage.getItem('key') || '' },
  set key(v){ localStorage.setItem('key', v||'') },
  get mode(){ return localStorage.getItem('mode') || 'exact' },
  set mode(v){ localStorage.setItem('mode', v||'exact') },
  get theme(){ return localStorage.getItem('theme') || 'light' },
  set theme(v){ localStorage.setItem('theme', v||'light') },
  get music(){ return localStorage.getItem('music') || 'on' },
  set music(v){ localStorage.setItem('music', v || 'on') },
};

function headers(){ const h={'Content-Type':'application/json'}; const k=state.key?.trim(); if(k) h['x-api-key']=k; return h; }
async function post(path, body){ const b=(state.api||'').replace(/\/$/,'')+path; const r=await fetch(b,{method:'POST',headers:headers(),body:JSON.stringify(body||{})}); if(!r.ok && r.status!==202) throw new Error(`${r.status} ${r.statusText}`); return r.json(); }
async function get(path){ const b=(state.api||'').replace(/\/$/,'')+path; const r=await fetch(b,{headers:headers()}); if(!r.ok) throw new Error(`${r.status} ${r.statusText}`); return r.text().catch(()=>r.statusText); }

/* ---------- Init (URL params ‚Üí fields) ---------- */
(function initFromURL(){
  const p = new URLSearchParams(location.search);
  const api = p.get('api'); const key = p.get('key'); const theme = p.get('theme');
  if(api){ state.api = api; } if(key){ state.key = key; } if(theme){ state.theme = theme; }
})();
(function initForm(){
  $('api').value=state.api; $('key').value=state.key; $('mode').value=state.mode;
  document.documentElement.setAttribute('data-theme', state.theme);
})();

/* ---------- Theme ---------- */
$('themeToggle').onclick = ()=>{
  state.theme = (state.theme === 'light') ? 'dark' : 'light';
  document.documentElement.setAttribute('data-theme', state.theme);
};

/* ---------- Music ---------- */
const bgm = $('bgm');
function applyMusic(){
  if(state.music==='on'){
    $('musicToggle').textContent = 'üîä Èü≥Ê®Ç';
    bgm.volume = 0.45;
    bgm.play().catch(()=>{/* Êúâ‰∫õÁÄèË¶ΩÂô®ÈúÄ‰∫íÂãïÂæåÊí≠Êîæ */});
  }else{
    $('musicToggle').textContent = 'üîà ÈùúÈü≥';
    bgm.pause();
  }
}
$('musicToggle').onclick = ()=>{
  state.music = (state.music==='on') ? 'off' : 'on';
  applyMusic();
};
applyMusic();

/* ---------- Overlay ---------- */
function showOverlay(msg){
  const el=$('overlay'); el.style.display='flex';
  if(msg) el.querySelector('.overlay-msg').textContent = msg;
}
function hideOverlay(){ $('overlay').style.display='none'; }

/* ---------- Helpers ---------- */
function parseAddress(addr){
  const s0=(addr||'').replace(/Ëá∫/g,'Âè∞').replace(/\s+/g,'').trim();
  const mCity=s0.match(/^(Âè∞ÂåóÂ∏Ç|Êñ∞ÂåóÂ∏Ç|Ê°ÉÂúíÂ∏Ç|Âè∞‰∏≠Â∏Ç|Âè∞ÂçóÂ∏Ç|È´òÈõÑÂ∏Ç|Âü∫ÈöÜÂ∏Ç|Êñ∞Á´πÂ∏Ç|ÂòâÁæ©Â∏Ç|Êñ∞Á´πÁ∏£|ËãóÊ†óÁ∏£|ÂΩ∞ÂåñÁ∏£|ÂçóÊäïÁ∏£|Èõ≤ÊûóÁ∏£|ÂòâÁæ©Á∏£|Â±èÊù±Á∏£|ÂÆúËò≠Á∏£|Ëä±ËìÆÁ∏£|Âè∞Êù±Á∏£|ÊæéÊπñÁ∏£|ÈáëÈñÄÁ∏£|ÈÄ£Ê±üÁ∏£)/);
  const city=mCity?mCity[1]:'';
  const r1=s0.slice(city.length);
  const mTown=r1.match(/^(.+?[Â∏ÇÂçÄÈÑâÈéÆ])/); const town=mTown?mTown[1]:'';
  const r2=r1.slice(town.length);
  const mRoad=r2.match(/^(.+?(?:Ë∑Ø|Ë°ó|Â§ßÈÅì|ÈÅì)(?:[‰∏Ä‰∫å‰∏âÂõõ‰∫îÂÖ≠‰∏ÉÂÖ´‰πùÂçÅ0-9]+ÊÆµ)?)/);
  const road=mRoad?mRoad[1]:'';
  const r3=r2.slice(road.length);
  const lane=(r3.match(/(\d+)\s*Â∑∑/)||[, ''])[1];
  const alley=(r3.match(/(\d+)\s*ÂºÑ/)||[, ''])[1];
  const num=(r3.match(/(\d+(?:-\d+)?)\s*Ëôü/)||[, ''])[1];
  const floor=(r3.match(/(\d+)\s*Ê®ì/)||[, ''])[1];
  return {city,town,road,lane,alley,num,floor};
}
function toCleanStatusText(t){
  // Âè™ÊÉ≥Áúã OK / FAILÔºå‰∏çË¶Å HTML
  if(!t) return 'Êú™Áü•';
  const s=String(t).toLowerCase();
  if(s.includes('ok')) return 'OK';
  if(s.includes('error')||s.includes('fail')||s.includes('internal')) return 'Â§±Êïó';
  return t.replace(/<[^>]+>/g,'').trim();
}

/* ---------- Storage ---------- */
$('save').onclick=()=>{ state.api=$('api').value; state.key=$('key').value; state.mode=$('mode').value; logLine('‚úÖ Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò'); };

/* ---------- ÂÖ®Á≥ªÁµ±ÂïüÂãï ---------- */
$('boot').onclick=async()=>{
  clearLog();
  showOverlay('üß† Êô∫ÊÖßÈÄ£Á∑ö‰∏≠ÔºåË´ãÁ®çÂÄô‚Ä¶');
  try{
    const base=(state.api||'').replace(/\/$/,'');
    const h = await fetch(base+'/health').then(r=>r.text()).catch(e=>String(e));
    logLine('üí° Â∑≤ÈÄ£Êé•Èõ≤Á´Ø‰ª£ÁêÜÔºö'+toCleanStatusText(h));

    const cbs = await get('/api/check-cbs').catch(e=>String(e));
    logLine('üí° CBS Session ÁãÄÊÖãÔºö'+toCleanStatusText(cbs));

    const bf  = await get('/api/check-bigfun').catch(e=>String(e));
    logLine('üí° BigFun È©óË≠âÔºö'+toCleanStatusText(bf));

    logLine('üåê Á≥ªÁµ±Â∞±Á∑íÔºåÈö®ÊôÇÁÇ∫ÊÇ®ÊúçÂãô');
  }catch(e){
    logLine('‚ùå ÂïüÂãïÂ§±ÊïóÔºö'+(e?.message||e));
  }finally{
    setTimeout(()=>hideOverlay(), 800); // ‰øùÁïô‰∏ÄÈªûË≥™ÊÑü
  }
};

/* ---------- EchoÔºàÂ§öË°å‰∏≠ÊñáÁ≤æÁ∞°Ôºâ ---------- */
$('echo').onclick=async()=>{
  clearLog();
  const addr = $('addr').value.trim();
  const p = parseAddress(addr);
  try{
    const cbs = toCleanStatusText(await get('/api/check-cbs').catch(e=>String(e)));
    const bf  = toCleanStatusText(await get('/api/check-bigfun').catch(e=>String(e)));

    logLine(`CBSÔºö${cbs}`);
    logLine(`BigFunÔºö${bf}`);
    logLine(`Âú∞ÂùÄËß£ÊûêÔºö${JSON.stringify(p)}`);
  }catch(e){
    logLine('‚ùå Echo Â§±ÊïóÔºö'+(e?.message||e));
  }
};

/* ---------- ‰ªªÂãôËº™Ë©¢ ---------- */
async function pollJob(jobId, label){
  logLine(`Ôºª${label}ÔºΩ‰ªªÂãôÂª∫Á´ãÔºö${jobId}`);
  for(;;){
    await new Promise(r=>setTimeout(r,2000));
    let j; 
    try{
      j = await fetch((state.api||'').replace(/\/$/,'')+'/api/jobs/'+jobId,{headers:headers()}).then(r=>r.json());
    }catch{ j=null; }
    if(!j){ logLine('‰ªªÂãô‰∏çÂ≠òÂú®ÊàñÈÄ£Á∑ö‰∏≠Êñ∑'); return; }

    if(j.status==='done'){
      const r=j.result||{};
      const land = r.landNo || r.land_no || '';
      const build= r.buildNoFull || r.building_no || '';
      const entrust = (typeof r.entrust==='string')? r.entrust : (r.message||'');
      logLine(`Âú∞ËôüÔºö${land}`);
      logLine(`Âª∫ËôüÔºö${build}`);
      if(entrust) logLine(`ÂßîË®óÔºö${entrust}`);
      return;
    }
    if(j.status==='error'){ logLine(`Â§±ÊïóÔºö${j.error||'unknown'}`); return; }
    // pending Á≠âÂæÖ‰∏≠‰∏çÂà∑‰∏ÄÂ†ÜÈªûÔºåÁî®Êõ¥ÂèãÂñÑÊñáÂ≠ó
    logLine('‚Ä¶ËôïÁêÜ‰∏≠');
  }
}

/* ---------- BigFun / Combo ---------- */
$('runBigfun').onclick=async()=>{
  clearLog();
  try{
    const resp = await post('/api/run-bigfun',{ address:$('addr').value.trim() });
    await pollJob(resp.jobId || resp.taskId || '(no id)', 'BigFun');
  }catch(e){ logLine('‚ùå BigFun Â§±ÊïóÔºö'+(e?.message||e)); }
};
$('runCombo').onclick=async()=>{
  clearLog();
  try{
    const resp = await post('/api/run-combo',{ address:$('addr').value.trim(), mode:state.mode, verify:'', lineOfficial:false });
    await pollJob(resp.jobId || resp.taskId || '(no id)', 'Combo');
  }catch(e){ logLine('‚ùå Combo Â§±ÊïóÔºö'+(e?.message||e)); }
};
$('abort').onclick=()=>logLine('ÔºàÁõÆÂâçÊîπÁÇ∫ËÉåÊôØ‰ªªÂãôÔºå‰∏çÊèê‰æõ abortÔºâ');
</script>
</body>
</html>
