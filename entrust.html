<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBS Agent æ§åˆ¶å°</title>
<style>
  :root{
    --bg:#f7f7f5;
    --panel:#ffffff;
    --muted:#6b7280;
    --text:#0a1a3f;
    --primary:#1e3a8a;
    --border:#e5e7eb;
    --code:#f3f4f6;
    --start:#1e3a8a;
    --start-ink:#ffffff;
    --info-bg:#e0e7ff;
    --info-ink:#1e293b;
    --stop-bg:#f3f4f6;
    --stop-ink:#111827;
    --close-bg:#111827;
    --close-ink:#ffffff;
    --ok:#16a34a;
    --bad:#dc2626;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.58 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;
  }
  .wrap{ max-width:760px; margin:18px auto 28px; padding:0 12px; }
  .hdr{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
  .hdr h2{ margin:0; font-size:18px; font-weight:800 }
  .hdr .tools{ display:flex; gap:10px; align-items:center }
  .btn-pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; border:1px solid #bcd0ff; color:#1e3a8a; background:#fff; font-weight:700; text-decoration:none }
  audio{ height:28px }

  .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 4px 12px rgba(2,6,23,.06); margin-bottom:12px; }
  label{ display:block; margin:4px 0 6px; font-weight:700; font-size:13px; }
  input, select{
    width:62%; padding:10px 12px; background:#fafafa; color:var(--text);
    border:1px solid var(--border); border-radius:10px; outline:none; transition:.2s ease;
  }
  input:focus, select:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px #dbeafe }

  .btn-row{ display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px; margin-top:10px; }
  button{ appearance:none; border:none; border-radius:12px; padding:10px 12px; font-weight:800; cursor:pointer; transition:.2s ease; }
  .btn-start{ background:var(--start); color:var(--start-ink); }
  .btn-start:hover{ filter:brightness(.95) }
  .btn-info{ background:var(--info-bg); color:var(--info-ink); border:1px solid #c7d2fe; }
  .btn-info:hover{ background:#cfe0ff }
  .btn-stop{ background:var(--stop-bg); color:var(--stop-ink); border:1px solid var(--border); }
  .btn-stop:hover{ background:#e9ecef }
  .btn-close{ background:var(--close-bg); color:var(--close-ink); }
  .btn-close:hover{ filter:brightness(1.05) }

  .pair{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap }
  .pair label{ min-width:72px; white-space:nowrap; }
  .input-wrap{ position:relative; display:flex; align-items:center; }
  .savebox{
    position:absolute;
    right:calc(21% + 2px);
    top:50%;
    transform:translateY(-50%);
    width:18px; height:18px; border:2px solid #9ca3af; border-radius:4px; background:#fff;
    display:inline-block; vertical-align:middle; z-index:1;
  }
  .savebox.on{ border-color:#16a34a; background:#16a34a; box-shadow:inset 0 0 0 2px #fff }
  .badge{ display:inline-flex; align-items:center; justify-content:center; height:20px; padding:0 8px; border-radius:999px; font-weight:700; font-size:12px; line-height:1; }
  .ok{ background:#ecfdf5; color:var(--ok); border:1px solid #bbf7d0 }
  .bad{ background:#fef2f2; color:var(--bad); border:1px solid #fecaca }
  .muted{ background:#eef2ff; color:#475569; border:1px solid #e2e8f0 }
  .log{ white-space:pre-wrap; overflow:auto; background:var(--code); border:1px solid var(--border); border-radius:10px; padding:12px; min-height:460px; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px }
</style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <h2>ğŸ  CBS Agent æ§åˆ¶å°</h2>
      <div class="tools">
        <a class="btn-pill" href="https://line.me/R/ti/p/@your-line" target="_blank" rel="noopener">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#1e3a8a"><path d="M19.729 4.271C18.144 2.686 15.808 2 12.999 2h-.002C6.925 2 3 5.612 3 10.197c0 2.535 1.12 4.781 2.978 6.313.154.126.247.314.25.514l.028 1.6a.75.75 0 0 0 1.202.6l1.779-1.336a.75.75 0 0 1 .449-.15h3.099c6.074 0 9.999-3.612 9.999-8.197 0-2.09-.686-4.144-2.055-5.57z"/></svg>
          LINEå®˜æ–¹
        </a>
        <audio id="bgm" controls src="https://dw5000tw-33.github.io/fbauto/the-truth-194426.mp3"></audio>
      </div>
    </div>

    <div class="card cfg">
      <div class="pair input-wrap">
        <label>API Base</label>
        <input id="api" placeholder="ä¾‹å¦‚ https://cbs-agent-docker.onrender.com" />
        <span id="saveBox" class="savebox" title="å„²å­˜ç‹€æ…‹"></span>
      </div>
      <div class="pair" style="margin-top:6px">
        <label>X-API-KEY</label>
        <input id="key" placeholder="å¯ç•™ç™½" />
      </div>
      <div class="pair" style="margin-top:6px; align-items:center">
        <label>æ¨¡å¼</label>
        <select id="mode">
          <option value="exact">exactï¼ˆç²¾æº–ï¼‰</option>
          <option value="fuzzy">fuzzyï¼ˆå¯¬é¬†ï¼‰</option>
        </select>
        <span id="healthStat" class="badge muted">æœªçŸ¥</span>
      </div>
      <div class="pair" style="margin-top:10px; gap:8px">
        <button class="btn-stop" id="save">ğŸ’¾ å„²å­˜</button>
        <button class="btn-info" id="ping">ğŸ” å¥åº·æª¢æŸ¥</button>
      </div>
    </div>

    <div class="card">
      <div class="pair">
        <label>æŸ¥è©¢åœ°å€</label>
        <input id="addr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚å—å±¯å€å¤§å¢©å—è·¯356è™Ÿ" style="flex:1" />
      </div>
      <div class="btn-row">
        <button class="btn-start" id="echo">Echo æ¸¬è©¦</button>
        <button class="btn-info" id="runCombo">åŸ·è¡Œ Combo</button>
        <button class="btn-stop" id="runBigfun">åƒ… BigFun</button>
        <button class="btn-close" id="abort">ä¸­æ­¢</button>
      </div>
      <label style="margin-top:10px">æ—¥èªŒè¼¸å‡º</label>
      <textarea id="log" class="log" spellcheck="false" placeholder="é€™è£¡æœƒé¡¯ç¤ºä¸²æµæ—¥èªŒ..."></textarea>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const state = {
      get api(){ return localStorage.getItem('api') || '' },
      set api(v){ localStorage.setItem('api', v || '') },
      get key(){ return localStorage.getItem('key') || '' },
      set key(v){ localStorage.setItem('key', v || '') },
      get mode(){ return localStorage.getItem('mode') || 'exact' },
      set mode(v){ localStorage.setItem('mode', v || 'exact') },
    };

    (function init(){
      $('api').value = state.api; $('key').value = state.key; $('mode').value = state.mode;
      $('saveBox').classList.remove('on');
    })();

    function badge(el, kind, text){
      el.className = 'badge ' + (kind||'muted');
      el.textContent = text;
    }
    function appendLog(txt){ const ta=$('log'); ta.value += txt + (txt.endsWith('\n')?'':'\n'); ta.scrollTop = ta.scrollHeight }
    function clearLog(){ $('log').value='' }

    const fmtBase = () => (state.api || '').replace(/\/$/, '');
    const stdHeaders = () => {
      const h = { 'Content-Type': 'application/json' };
      const k = (state.key || '').trim();
      if (k) h['X-API-KEY'] = k;
      return h;
    };

    async function fetchJSON(url, opts={}){
      const res = await fetch(url, opts);
      const text = await res.text();
      let data = text;
      try { data = JSON.parse(text) } catch {}
      return { ok: res.ok, status: res.status, data };
    }

    // å¥åº·æª¢æŸ¥
    $('ping').onclick = async()=>{
      clearLog(); appendLog('æª¢æŸ¥å¥åº·ç‹€æ…‹...');
      badge($('healthStat'), 'muted', 'æª¢æŸ¥ä¸­');
      try{
        const r = await fetch(fmtBase() + '/health');
        const t = await r.text(); appendLog(t || r.status);
        badge($('healthStat'), 'ok', 'OK');
      }catch(err){
        appendLog('health å¤±æ•—ï¼š' + (err.message || err));
        badge($('healthStat'), 'bad', 'å¤±æ•—');
      }
    };

    // Echo æ¸¬è©¦ï¼ˆåŒæ­¥ï¼‰
    $('echo').onclick = async()=>{
      clearLog(); appendLog('Echo æ¸¬è©¦...');
      try{
        const r = await fetchJSON(fmtBase() + '/api/echo-address', {
          method: 'POST',
          headers: stdHeaders(),
          body: JSON.stringify({ address: $('addr').value, mode: state.mode })
        });
        appendLog('['+r.status+'] ' + (typeof r.data==='string' ? r.data : JSON.stringify(r.data, null, 2)));
      }catch(err){ appendLog('echo error: ' + (err.message || err)); }
    };

    // éåŒæ­¥ä»»å‹™ï¼ˆå…¼å®¹ï¼šè‹¥å¾Œç«¯ç›´æ¥å› 200 çµæœä¹Ÿèƒ½è™•ç†ï¼‰
    let stopFlag = false;
    const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));

    async function startJob(kind, payload){
      stopFlag = false;
      const base = fmtBase();

      const r = await fetchJSON(base + '/api/' + kind, {
        method: 'POST',
        headers: stdHeaders(),
        body: JSON.stringify(payload || {})
      });

      // A) æˆ‘å€‘çš„æ–°å¾Œç«¯ï¼š202 + {jobId}
      if (r.status === 202 && r.data && r.data.jobId) {
        const jobId = r.data.jobId;
        appendLog(`å·²å»ºç«‹ä»»å‹™ ${kind}ï¼ŒjobId=${jobId}ï¼Œé–‹å§‹è¼ªè©¢...`);
        while (!stopFlag) {
          await sleep(1500);
          const s = await fetchJSON(base + '/api/jobs/' + jobId, { headers: stdHeaders() });
          if (!s.ok) { appendLog(`æŸ¥è©¢å¤±æ•— [${s.status}]`); break; }
          if (s.data.status === 'pending') { appendLog('è™•ç†ä¸­...'); continue; }
          if (s.data.status === 'done')   { appendLog('âœ… å®Œæˆï¼š' + JSON.stringify(s.data.result, null, 2)); return; }
          if (s.data.status === 'error')  { appendLog('âŒ å¤±æ•—ï¼š' + s.data.error); return; }
          appendLog('æœªçŸ¥ç‹€æ…‹ï¼š' + JSON.stringify(s.data));
        }
        if (stopFlag) appendLog('â¹ å·²ä¸­æ­¢è¼ªè©¢');
        return;
      }

      // B) èˆŠå¾Œç«¯ï¼šç›´æ¥å› 200 çµæœ
      appendLog('['+r.status+'] ' + (typeof r.data==='string' ? r.data : JSON.stringify(r.data, null, 2)));
    }

    $('runCombo').onclick = async()=>{
      clearLog(); appendLog('åŸ·è¡Œ Combo...');
      try{
        await startJob('run-combo', {
          address: $('addr').value,
          mode: state.mode,
          verify: '',
          lineOfficial: false
        });
      }catch(err){ appendLog('combo error: ' + (err.message || err)); }
    };

    $('runBigfun').onclick = async()=>{
      clearLog(); appendLog('åŸ·è¡Œ BigFun...');
      try{
        await startJob('run-bigfun', {
          address: $('addr').value,
          show: '0'
        });
      }catch(err){ appendLog('bigfun error: ' + (err.message || err)); }
    };

    $('abort').onclick = async()=>{
      stopFlag = true;
      appendLog('â¹ å˜—è©¦ä¸­æ­¢ï¼ˆè‹¥å¾Œç«¯æ”¯æ´ /api/abort æœƒä¸€ä½µé€šçŸ¥ï¼‰');
      try{
        const r = await fetch(fmtBase() + '/api/abort', {
          method: 'POST',
          headers: stdHeaders(),
          body: JSON.stringify({})
        });
        appendLog('abort: ' + (await r.text()));
      }catch(e){ /* å¾Œç«¯æ²’æä¾›ä¹Ÿæ²’é—œä¿‚ */ }
    };

    // å„²å­˜
    $('save').onclick = ()=>{
      state.api  = $('api').value;
      state.key  = $('key').value;
      state.mode = $('mode').value;
      $('saveBox').classList.add('on');
    };
  </script>
</body>
</html>
