<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBS Agent æ§åˆ¶å°</title>
  <style>
    :root{
      --bg:#f7f7f5; --panel:#ffffff; --muted:#6b7280; --text:#0a1a3f;
      --primary:#1e3a8a; --border:#e5e7eb; --code:#f3f4f6;
      --ok:#16a34a; --bad:#dc2626; --warn:#a16207;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.58 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    .wrap{max-width:820px;margin:18px auto 28px;padding:0 16px}
    .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .hdr h2{margin:0;font-size:18px;font-weight:800}
    .hdr-right{display:flex;align-items:center;gap:10px;flex-wrap:nowrap}
    .link-btn{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      background:#eef2ff;color:#1e293b;border:1px solid #c7d2fe;
      font-weight:700;font-size:13px;text-decoration:none;
    }
    .link-btn:hover{filter:brightness(0.98)}
    .hdr-audio{height:28px}


    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 4px 12px rgba(2,6,23,.06);margin-bottom:12px}
    .grid2{display:grid;grid-template-columns:160px 1fr;gap:10px 12px;align-items:center}
    .row{display:flex;gap:8px;align-items:center}
    label{margin:0;font-weight:700;font-size:13px;color:#111827}
    input,select{width:100%;padding:10px 12px;background:#fafafa;color:var(--text);border:1px solid var(--border);border-radius:10px;outline:none}
    input:focus,select:focus{border-color:#93c5fd;box-shadow:0 0 0 3px #dbeafe}

    .btn-row{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:8px;margin-top:10px}
    button{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn-start{background:#1e3a8a;color:#fff}
    .btn-info{background:#e0e7ff;color:#1e293b;border:1px solid #c7d2fe}
    .btn-stop{background:#f3f4f6;color:#111827;border:1px solid var(--border)}
    .btn-close{background:#111827;color:#fff}

    .badge{display:inline-flex;align-items:center;justify-content:center;height:22px;padding:0 10px;border-radius:999px;font-weight:700;font-size:12px}
    .ok{background:#ecfdf5;color:var(--ok);border:1px solid #bbf7d0}
    .warn{background:#fffbeb;color:var(--warn);border:1px solid #fde68a}
    .bad{background:#fef2f2;color:var(--bad);border:1px solid #fecaca}
    .muted{background:#eef2ff;color:#475569;border:1px solid #e2e8f0}

    .log{white-space:pre-wrap;overflow:auto;background:var(--code);border:1px solid var(--border);border-radius:10px;padding:12px;min-height:420px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
  <h2>ğŸ  CBS Agent æ§åˆ¶å°</h2>
  <div class="hdr-right">
    <a class="link-btn" href="https://line.me/R/ti/p/@307momvl" target="_blank">ğŸ’¬ LINE å®˜æ–¹</a>
    <audio id="bgm" class="hdr-audio" controls preload="metadata"></audio>
  </div>
</div>


    <!-- è¨­å®šå€ -->
    <div class="card">
      <div class="grid2">
        <label for="api">API Base</label>
        <input id="api" placeholder="ä¾‹å¦‚ï¼šhttps://cbs-agent-docker.onrender.com" />

        <label for="key">X-API-KEY</label>
        <input id="key" placeholder="å¯ç•™ç™½" />

        <label for="mode">æ¨¡å¼</label>
        <div class="row">
          <select id="mode" style="max-width:220px">
            <option value="exact">exactï¼ˆç²¾æº–ï¼‰</option>
            <option value="fuzzy">fuzzyï¼ˆå¯¬é¬†ï¼‰</option>
          </select>
          <span id="healthStat" class="badge muted">æœªçŸ¥</span>
        </div>

        <div></div>
        <div class="row" style="gap:8px">
          <button class="btn-stop" id="save">ğŸ’¾ å„²å­˜</button>
          <button class="btn-info" id="ping">ğŸ” å¥åº·æª¢æŸ¥</button>
        </div>
      </div>
    </div>

    <!-- æ“ä½œå€ -->
    <div class="card">
      <div class="grid2">
        <label for="addr">æŸ¥è©¢åœ°å€</label>
        <input id="addr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚å—å±¯å€å¤§å¢©å—è·¯356è™Ÿ" />
      </div>

      <div class="btn-row">
        <button class="btn-start" id="echo">Echo æ¸¬è©¦</button>
        <button class="btn-info" id="runCombo">åŸ·è¡Œ Combo</button>
        <button class="btn-stop" id="runBigfun">åƒ… BigFun</button>
        <button class="btn-close" id="abort" disabled>ä¸­æ­¢</button>
      </div>

      <label style="display:block;margin:12px 0 6px;font-weight:700">æ—¥èªŒè¼¸å‡º</label>
      <textarea id="log" class="log" spellcheck="false" placeholder="é€™è£¡æœƒé¡¯ç¤ºä¸²æµæ—¥èªŒ..."></textarea>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
function appendLog(t){ const ta=$('log'); ta.value += (typeof t==='string'? t : JSON.stringify(t,null,2)) + '\n'; ta.scrollTop = ta.scrollHeight; }
function clearLog(){ $('log').value=''; }

const state = {
  get api(){ return localStorage.getItem('api') || '' },
  set api(v){ localStorage.setItem('api', v||'') },
  get key(){ return localStorage.getItem('key') || '' },
  set key(v){ localStorage.setItem('key', v||'') },
  get mode(){ return localStorage.getItem('mode') || 'exact' },
  set mode(v){ localStorage.setItem('mode', v||'exact') },
};
(function init(){ $('api').value=state.api; $('key').value=state.key; $('mode').value=state.mode; })();

function headers(){ const h={'Content-Type':'application/json'}; const k=state.key?.trim(); if(k) h['x-api-key']=k; return h; }
async function post(path, body){
  const b=(state.api||'').replace(/\/$/,'')+path;
  const r=await fetch(b,{method:'POST',headers:headers(),body:JSON.stringify(body||{})});
  if(!r.ok && r.status!==202) throw new Error(`${r.status} ${r.statusText}`);
  return r.json();
}
async function get(path){
  const b=(state.api||'').replace(/\/$/,'')+path;
  const r=await fetch(b,{headers:headers()});
  if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
  return r.json().catch(async()=>({ raw: await r.text() }));
}

// -------- åœ°å€è§£æï¼ˆå¤šè¡Œä¸­æ–‡ï¼‰ --------
function parseTaiwanAddress(addrRaw){
  if(!addrRaw) return { city:'', town:'', road:'', lane:'', alley:'', num:'', floor:'' };
  let s = addrRaw.replace(/è‡º/g,'å°').replace(/\s+/g,'');
  const cities = /(å°åŒ—å¸‚|æ–°åŒ—å¸‚|æ¡ƒåœ’å¸‚|å°ä¸­å¸‚|å°å—å¸‚|é«˜é›„å¸‚|åŸºéš†å¸‚|æ–°ç«¹å¸‚|å˜‰ç¾©å¸‚|æ–°ç«¹ç¸£|è‹—æ —ç¸£|å½°åŒ–ç¸£|å—æŠ•ç¸£|é›²æ—ç¸£|å˜‰ç¾©ç¸£|å±æ±ç¸£|å®œè˜­ç¸£|èŠ±è“®ç¸£|å°æ±ç¸£|æ¾æ¹–ç¸£|é‡‘é–€ç¸£|é€£æ±Ÿç¸£)/;
  const mCity = s.match(cities); const city = mCity? mCity[1]:''; s = city? s.slice(city.length):s;
  const mTown = s.match(/^(.+?[å¸‚å€é„‰é®])/); const town = mTown? mTown[1]:''; s = town? s.slice(town.length):s;
  const mRoad = s.match(/^(.+?(?:è·¯|è¡—|å¤§é“|é“)(?:[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å0-9]+æ®µ)?)/);
  let road=''; if(mRoad){ road=mRoad[1]; s=s.slice(road.length); }
  const lane = (s.match(/(\d+)\s*å··/)||[, ''])[1];
  const alley= (s.match(/(\d+)\s*å¼„/)||[, ''])[1];
  const num  = (s.match(/(\d+(?:-\d+)?)\s*è™Ÿ/)||[, ''])[1];
  const floor= (s.match(/(\d+)\s*æ¨“/)||[, ''])[1];
  return { city,town,road,lane,alley,num,floor };
}
function printParsedChinese(p){
  appendLog('åœ°å€è§£ææˆåŠŸ âœ…');
  appendLog(`åŸå¸‚ï¼š${p.city||'-'}`);
  appendLog(`å€åŸŸï¼š${p.town||'-'}`);
  appendLog(`è·¯åï¼š${p.road||'-'}`);
  appendLog(`å··ï¼š${p.lane||'-'}`);
  appendLog(`å¼„ï¼š${p.alley||'-'}`);
  appendLog(`é–€ç‰Œï¼š${p.num? p.num+'è™Ÿ':'-'}`);
  appendLog(`æ¨“å±¤ï¼š${p.floor||'-'}`);
}

// -------- å¥åº·æª¢æŸ¥ï¼ˆç²¾ç°¡è¼¸å‡ºï¼‰ --------
$('ping').onclick=async()=>{
  clearLog(); appendLog('æª¢æŸ¥å¥åº·ç‹€æ…‹...');
  const base = (state.api||'').replace(/\/$/,'');
  const badge = $('healthStat'); badge.className='badge muted'; badge.textContent='æª¢æŸ¥ä¸­';
  try{
    // API
    const t = await fetch(base+'/health').then(r=>r.text()).catch(()=>null);
    const apiOk = (t||'').toUpperCase().includes('OK');
    appendLog(apiOk ? 'âœ… API æ­£å¸¸' : 'âŒ API é€£ç·šå¤±æ•—');
    badge.className = 'badge ' + (apiOk? 'ok':'bad'); badge.textContent = apiOk? 'OK':'å¤±æ•—';

    // CBS / BigFunï¼ˆåªçœ‹ç‹€æ…‹ç¢¼ï¼Œä¸è¼¸å‡º HTMLï¼‰
    const cbsOk = await fetch(base+'/api/check-cbs').then(r=>r.ok).catch(()=>false);
    const bfOk  = await fetch(base+'/api/check-bigfun').then(r=>r.ok).catch(()=>false);
    appendLog(cbsOk ? 'âœ… CBS å·²ç™»å…¥' : 'âš ï¸ CBS æœªç™»å…¥ï¼ˆè«‹åœ¨æ¡Œæ©Ÿç™»å…¥ï¼‰');
    appendLog(bfOk  ? 'âœ… BigFun å·²ç™»å…¥' : 'âš ï¸ BigFun æœªç™»å…¥ï¼ˆè«‹åœ¨æ¡Œæ©Ÿç™»å…¥ï¼‰');
  }catch(e){
    appendLog('âŒ æª¢æŸ¥å¤±æ•—ï¼š'+e.message);
    badge.className='badge bad'; badge.textContent='å¤±æ•—';
  }
};

// -------- Echoï¼ˆåªå°åœ°å€è§£æï¼å¤šè¡Œä¸­æ–‡ï¼‰ --------
$('echo').onclick=async()=>{
  clearLog(); appendLog('Echo æ¸¬è©¦ä¸­...');
  const p = parseTaiwanAddress($('addr').value.trim());
  printParsedChinese(p);
};

// -------- é•·ä»»å‹™è¼ªè©¢ --------
async function pollJob(jobId, label){
  appendLog(`é–‹å§‹åŸ·è¡Œï¼š${label}ï¼ˆjob=${jobId}ï¼‰`);
  for(;;){
    await new Promise(r=>setTimeout(r,2000));
    let j = null;
    try{ j = await get('/api/jobs/'+jobId); }catch{ }
    if(!j){ appendLog('âš ï¸ ä¼ºæœå™¨å›æ‡‰ç¼ºå¤±æˆ–ä»»å‹™ä¸å­˜åœ¨'); return; }
    if(j.status==='done'){
      const r=j.result||{};
      appendLog('ã€å®Œæˆã€‘');
      if(r.landNo || r.buildNoFull || r.entrust){
        if(r.landNo)     appendLog('åœ°è™Ÿï¼š'+r.landNo);
        if(r.buildNoFull)appendLog('å»ºè™Ÿï¼š'+r.buildNoFull);
        if(r.entrust!==undefined) appendLog('å§”è¨—ï¼š'+r.entrust);
      }else{
        appendLog(JSON.stringify(r,null,2));
      }
      return;
    }
    if(j.status==='error'){ appendLog('ã€å¤±æ•—ã€‘'+(j.error||'')); return; }
    appendLog('ç­‰å¾…æ¡Œæ©Ÿå›æ‡‰ä¸­â€¦ï¼ˆç‹€æ…‹ï¼š'+j.status+'ï¼‰');
  }
}

// -------- æ“ä½œæŒ‰éˆ• --------
$('save').onclick=()=>{ state.api=$('api').value; state.key=$('key').value; state.mode=$('mode').value; };

$('runBigfun').onclick=async()=>{
  clearLog(); appendLog('åŸ·è¡Œ BigFun...');
  try{
    const resp = await post('/api/run-bigfun',{ address:$('addr').value.trim() });
    appendLog(`[job] ${resp.jobId||'(no id)'} å·²å»ºç«‹`);
    await pollJob(resp.jobId, 'BigFun');
  }catch(e){ appendLog('âŒ '+e.message); }
};

$('runCombo').onclick=async()=>{
  clearLog(); appendLog('åŸ·è¡Œ Combo...');
  try{
    const resp = await post('/api/run-combo',{ address:$('addr').value.trim(), mode:state.mode, verify:'', lineOfficial:false });
    appendLog(`[job] ${resp.jobId||'(no id)'} å·²å»ºç«‹`);
    await pollJob(resp.jobId, 'Combo');
  }catch(e){ appendLog('âŒ '+e.message); }
};

$('abort').onclick=()=>appendLog('ï¼ˆæ”¹ç‚ºèƒŒæ™¯ä»»å‹™ï¼Œä¸æä¾›ä¸­æ­¢ï¼‰');
  (function setupHeaderMedia(){
  const AUDIO_SRC = localStorage.getItem('bgm_src')
    || 'https://dw5000tw-33.github.io/fbauto/the-truth-194426.mp3';
  const audio = document.getElementById('bgm');
  if (!audio) return;
  audio.src = AUDIO_SRC;

  const savedMuted = localStorage.getItem('bgm_muted');
  const savedVol   = localStorage.getItem('bgm_vol');
  if (savedMuted !== null) audio.muted = savedMuted === 'true';
  if (savedVol   !== null) audio.volume = Math.min(1, Math.max(0, Number(savedVol)));

  audio.addEventListener('volumechange', ()=>{
    localStorage.setItem('bgm_muted', String(audio.muted));
    localStorage.setItem('bgm_vol',   String(audio.volume));
  });
})();

</script>
</body>
</html>
