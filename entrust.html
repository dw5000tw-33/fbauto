<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBS Agent 控制台</title>
<style>
  :root{
    --bg:#f7f7f5;
    --panel:#ffffff;
    --muted:#6b7280;
    --text:#0a1a3f;
    --primary:#1e3a8a;
    --border:#e5e7eb;
    --code:#f3f4f6;
    --start:#1e3a8a;
    --start-ink:#ffffff;
    --info-bg:#e0e7ff;
    --info-ink:#1e293b;
    --stop-bg:#f3f4f6;
    --stop-ink:#111827;
    --close-bg:#111827;
    --close-ink:#ffffff;
    --ok:#16a34a;
    --bad:#dc2626;
  }
  *{ box-sizing:border-box }
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:14px/1.58 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif;
  }
  .wrap{ max-width:760px; margin:18px auto 28px; padding:0 12px; }
  .hdr{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
  .hdr h2{ margin:0; font-size:18px; font-weight:800 }
  .hdr .tools{ display:flex; gap:10px; align-items:center }
  .btn-pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; border:1px solid #bcd0ff; color:#1e3a8a; background:#fff; font-weight:700; text-decoration:none }
  audio{ height:28px }

  .card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 4px 12px rgba(2,6,23,.06); margin-bottom:12px; }
  label{ display:block; margin:4px 0 6px; font-weight:700; font-size:13px; }
  input, select{
    width:62%; padding:10px 12px; background:#fafafa; color:var(--text);
    border:1px solid var(--border); border-radius:10px; outline:none; transition:.2s ease;
  }
  input:focus, select:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px #dbeafe }

  .btn-row{ display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px; margin-top:10px; }
  button{ appearance:none; border:none; border-radius:12px; padding:10px 12px; font-weight:800; cursor:pointer; transition:.2s ease; }
  .btn-start{ background:var(--start); color:var(--start-ink); }
  .btn-start:hover{ filter:brightness(.95) }
  .btn-info{ background:var(--info-bg); color:var(--info-ink); border:1px solid #c7d2fe; }
  .btn-info:hover{ background:#cfe0ff }
  .btn-stop{ background:var(--stop-bg); color:var(--stop-ink); border:1px solid var(--border); }
  .btn-stop:hover{ background:#e9ecef }
  .btn-close{ background:var(--close-bg); color:var(--close-ink); }
  .btn-close:hover{ filter:brightness(1.05) }

  .pair{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap }
  .pair label{ min-width:72px; white-space:nowrap; }
  .input-wrap{ position:relative; display:flex; align-items:center; }
  /* 只有這裡改了：把儲存方框往左、貼近輸入框，並且水平落在「未知」徽章的上方區域 */
  .savebox{
    position:absolute;
    right:calc(62% + 0px); /* 38% = 剩餘寬度 (100% - 輸入框 62%)，放在右側區塊的最左緣，剛好在徽章上方 */
    top:50%;
    transform:translateY(-50%);
    width:18px; height:18px; border:2px solid #9ca3af; border-radius:4px; background:#fff;
    display:inline-block; vertical-align:middle; z-index:1;
  }
  .savebox.on{ border-color:#16a34a; background:#16a34a; box-shadow:inset 0 0 0 2px #fff }
  .badge{ display:inline-flex; align-items:center; justify-content:center; height:20px; padding:0 8px; border-radius:999px; font-weight:700; font-size:12px; line-height:1; }
  .ok{ background:#ecfdf5; color:var(--ok); border:1px solid #bbf7d0 }
  .bad{ background:#fef2f2; color:var(--bad); border:1px solid #fecaca }
  .muted{ background:#eef2ff; color:#475569; border:1px solid #e2e8f0 }
  .log{ white-space:pre-wrap; overflow:auto; background:var(--code); border:1px solid var(--border); border-radius:10px; padding:12px; min-height:460px; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px }
</style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <h2>🏠 CBS Agent 控制台</h2>
      <div class="tools">
        <a class="btn-pill" href="https://line.me/R/ti/p/@your-line" target="_blank" rel="noopener">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="#1e3a8a"><path d="M19.729 4.271C18.144 2.686 15.808 2 12.999 2h-.002C6.925 2 3 5.612 3 10.197c0 2.535 1.12 4.781 2.978 6.313.154.126.247.314.25.514l.028 1.6a.75.75 0 0 0 1.202.6l1.779-1.336a.75.75 0 0 1 .449-.15h3.099c6.074 0 9.999-3.612 9.999-8.197 0-2.09-.686-4.144-2.055-5.57z"/></svg>
          LINE官方
        </a>
        <audio id="bgm" controls src="https://dw5000tw-33.github.io/fbauto/the-truth-194426.mp3"></audio>
      </div>
    </div>

    <div class="card cfg">
      <div class="pair input-wrap">
        <label>API Base</label>
        <input id="api" placeholder="例如 https://cbs-agent-docker.onrender.com" />
        <span id="saveBox" class="savebox" title="儲存狀態"></span>
      </div>
      <div class="pair" style="margin-top:6px">
        <label>X-API-KEY</label>
        <input id="key" placeholder="可留白" />
      </div>
      <div class="pair" style="margin-top:6px; align-items:center">
        <label>模式</label>
        <select id="mode">
          <option value="exact">exact（精準）</option>
          <option value="fuzzy">fuzzy（寬鬆）</option>
        </select>
        <span id="healthStat" class="badge muted">未知</span>
      </div>
      <div class="pair" style="margin-top:10px; gap:8px">
        <button class="btn-stop" id="save">💾 儲存</button>
        <button class="btn-info" id="ping">🔎 健康檢查</button>
      </div>
    </div>

    <div class="card">
      <div class="pair">
        <label>查詢地址</label>
        <input id="addr" placeholder="例：台中市南屯區大墩南路356號" style="flex:1" />
      </div>
      <div class="btn-row">
        <button class="btn-start" id="echo">Echo 測試</button>
        <button class="btn-info" id="runCombo">執行 Combo</button>
        <button class="btn-stop" id="runBigfun">僅 BigFun</button>
        <button class="btn-close" id="abort">中止</button>
      </div>
      <label style="margin-top:10px">日誌輸出</label>
      <textarea id="log" class="log" spellcheck="false" placeholder="這裡會顯示串流日誌..."></textarea>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const state = {
      get api(){ return localStorage.getItem('api') || '' },
      set api(v){ localStorage.setItem('api', v || '') },
      get key(){ return localStorage.getItem('key') || '' },
      set key(v){ localStorage.setItem('key', v || '') },
      get mode(){ return localStorage.getItem('mode') || 'exact' },
      set mode(v){ localStorage.setItem('mode', v || 'exact') },
    };

    (function init(){
      $('api').value = state.api; $('key').value = state.key; $('mode').value = state.mode;
      $('saveBox').classList.remove('on');
    })();

    function badge(el, kind, text){
      el.className = 'badge ' + (kind||'muted');
      el.textContent = text;
    }
    function appendLog(txt){ const ta=$('log'); ta.value += txt; ta.scrollTop = ta.scrollHeight }
    function clearLog(){ $('log').value='' }

    async function doFetch(path, opts={}){
      const base = state.api?.trim();
      if(!base) throw new Error('尚未設定 API Base');
      const headers = {'Content-Type':'application/json'};
      const k = state.key?.trim(); if(k) headers['x-api-key']=k;
      const res = await fetch(base.replace(/\/$/, '') + path, { method:'POST', headers, ...opts });
      if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return res;
    }

    $('save').onclick = ()=>{
      state.api  = $('api').value;
      state.key  = $('key').value;
      state.mode = $('mode').value;
      $('saveBox').classList.add('on');
    };

    $('ping').onclick = async()=>{
      clearLog(); appendLog('檢查健康狀態...\n');
      badge($('healthStat'), 'muted', '檢查中');
      try{
        const r = await fetch((state.api||'').replace(/\/$/, '') + '/health');
        const t = await r.text(); appendLog(t);
        badge($('healthStat'), 'ok', 'OK');
      }catch(err){
        appendLog('health 失敗：'+err.message+'\n');
        badge($('healthStat'), 'bad', '失敗');
      }
    };

    $('echo').onclick = async()=>{
      clearLog(); appendLog('Echo 測試中...\n');
      try{
        const res = await doFetch('/api/echo-address', { body: JSON.stringify({ address:$('addr').value }) });
        appendLog(JSON.stringify(await res.json(), null, 2));
      }catch(err){ appendLog(err.message+'\n'); }
    };

    $('runBigfun').onclick = async()=>{
      clearLog(); appendLog('執行 BigFun...\n');
      try{
        const res = await doFetch('/api/run-bigfun', { body: JSON.stringify({ address:$('addr').value, show:'0' }) });
        const reader = res.body.getReader(); const dec = new TextDecoder();
        while(true){ const {done, value} = await reader.read(); if(done) break; appendLog(dec.decode(value)) }
      }catch(err){ appendLog(err.message+'\n'); }
    };

    $('runCombo').onclick = async()=>{
      clearLog(); appendLog('執行 Combo...\n');
      try{
        const res = await doFetch('/api/run-combo', { body: JSON.stringify({ address: $('addr').value, mode: state.mode, verify: '', lineOfficial: false }) });
        const reader = res.body.getReader(); const dec = new TextDecoder();
        while(true){ const {done, value} = await reader.read(); if(done) break; appendLog(dec.decode(value)) }
      }catch(err){ appendLog(err.message+'\n'); }
    };

    $('abort').onclick = async()=>{
      try{ const res = await doFetch('/api/abort', { body: JSON.stringify({}) }); appendLog('\n' + (await res.text())) }catch(err){ appendLog(err.message+'\n') }
    };
  </script>
</body>
</html>
