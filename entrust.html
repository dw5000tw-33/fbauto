
<!DOCTYPE html>
<html lang="zh-Hant" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> æˆ¿ä»²å§”è¨—æŸ¥è©¢å¹³å° v1.0</title>
  <link rel="icon" href="./logo.png" />
  <style>
:root{
  --bg:#f7f7f5;
  --panel:#ffffff;
  --text:#0a1a3f;
  --muted:#6b7280;
  --border:#e5e7eb;
  --code:#f3f4f6;
  --primary:#1e3a8a;
  --ok:#16a34a; --bad:#dc2626; --warn:#a16207;
  --btn:#1e3a8a; --btn-ink:#ffffff;
  --input-bg:#ffffff;
  --log-ink:#1f2937;
}
html[data-theme="dark"]{
  --bg:#0b0f14;
  --panel:#11161d;
  --text:#e6edf3;
  --muted:#94a3b8;
  --border:#263241;
  --code:#0f1720;
  --primary:#60a5fa;
  --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
  --btn:#60a5fa; --btn-ink:#0b1220;
  --input-bg:#0f141b;
  --log-ink:#e5e7eb;
}

/* æ‰‹æ©Ÿè¦–è¦ºä¿®æ­£ï¼šä¸‰é¡†ç¶­æŒåŒä¸€æ’ï¼Œä½†æ›´ç²¾ç·»ã€ä¸æ“ ä¸ç‚¸ */
@media (max-width: 600px) {
  .hdr-controls{
    display:flex;
    gap:8px;
    flex-wrap:nowrap;
    justify-content:flex-start;
  }
  .hdr-controls a.btn-pill,
  .hdr-controls button.btn-pill,
  .hdr-controls #themeToggle{
    font-size: clamp(12px, 3.5vw, 14px);
    padding: 5px 10px;      /* æ¯”æ¡Œæ©Ÿç•¥æ”¶ä¸€é»ï¼Œè¦–è¦ºä¸è‡ƒè…« */
    line-height: 1;         /* èˆ‡æ¡Œæ©Ÿä¸€è‡´ï¼Œé¿å…é«˜åº¦è·³å‹• */
    white-space: nowrap;    /* ä¸æ›è¡Œï¼Œä¸æ“ å­— */
    flex: 0 0 auto;         /* ä¸æŠŠæ•´è¡Œæ’æ»¿ï¼Œä¸è®Šé•·æ¢ */
  }
}



*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.58 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
.wrap{max-width:860px;margin:20px auto 32px;padding:0 16px}
.hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{margin:0;font-size:20px;font-weight:900;letter-spacing:.2px;display:flex;gap:8px;align-items:center}
.hdr-controls{display:flex;align-items:center;gap:10px}
.theme-toggle{appearance:none;border:1px solid var(--border);background:var(--panel);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:700}
.btn-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:999px;border:1px solid var(--border);color:var(--text);background:var(--panel);font-weight:700}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 6px 16px rgba(0,0,0,.35);margin-bottom:12px}
.grid2{display:grid;grid-template-columns:160px 1fr;gap:10px 12px;align-items:center}
label{margin:0;font-weight:800;font-size:13px;color:var(--text)}
input,select,textarea{width:100%;padding:10px 12px;color:var(--text);background:var(--input-bg);border:1px solid var(--border);border-radius:10px;outline:none}
/* è®“ focus æœ‰å‹•ç•«éæ¸¡ */
input,select,textarea{transition:border-color .18s ease, box-shadow .18s ease, background-color .18s ease}
input::placeholder,textarea::placeholder{color:#6b7280}
.btn-row{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:10px}
button{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-primary{background:var(--btn);color:var(--btn-ink)}
.btn-info{background:#e0e7ff;color:#1e293b;border:1px solid #c7d2fe}
html[data-theme="dark"] .btn-info{background:#1f2937;color:#cfe0ff;border-color:#334155}
.btn-stop{background:#f3f4f6;color:#111827;border:1px solid var(--border)}
html[data-theme="dark"] .btn-stop{background:#0f141b;color:#e5e7eb;border-color:#border}
.btn-close{background:#111827;color:#fff}
.log{white-space:pre-wrap;overflow:auto;background:var(--code);border:1px solid var(--border);border-radius:10px;padding:12px;min-height:420px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;color:var(--log-ink)}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;z-index:9999;color:#e8ebf0}
html[data-theme="light"] .overlay{background:#ffffff;color:#0b0c0f}
.overlay .logo-big{width:68px;height:68px;border-radius:18px;background:linear-gradient(135deg,#4f46e5,#06b6d4);display:grid;place-items:center;color:#fff;font-weight:900;font-size:28px}
.spinner{width:38px;height:38px;border-radius:50%;border:3px solid rgba(255,255,255,.25);border-top-color:#fff;animation:spin 1s linear infinite}
html[data-theme="light"] .spinner{border-color:rgba(0,0,0,.1);border-top-color:#0b0c0f}
@keyframes spin{to{transform:rotate(360deg)}}
.pulse{position:relative;width:120px;height:24px}
.pulse::before,.pulse::after{content:"";position:absolute;inset:0;border-radius:999px;background:radial-gradient(circle,rgba(99,102,241,.85),transparent 55%),radial-gradient(circle,rgba(16,185,129,.85),transparent 55%),radial-gradient(circle,rgba(59,130,246,.85),transparent 55%);animation:pulse 2.4s ease-in-out infinite;mix-blend-mode:screen;opacity:.85}
.pulse::after{animation-delay:.8s;filter:blur(6px);opacity:.55}
@keyframes pulse{0%{transform:scale(.85);opacity:.7}50%{transform:scale(1.06);opacity:1}100%{transform:scale(.85);opacity:.7}}
@media(max-width:640px){ .grid2{grid-template-columns:1fr} }

/* ===================== ä½ æŒ‡å®šçš„æ”¹å‹• ===================== */
/* äº®è‰²ä¸»é¡Œï¼šè¼¸å…¥æ¡†èšç„¦ = æ·±è‰²é‚Šæ¡† + å¾®é™°å½± */
html[data-theme="light"] input:focus,
html[data-theme="light"] select:focus,
html[data-theme="light"] textarea:focus{
  border-color:#0b0c0f;
  box-shadow:0 0 0 3px rgba(10,26,63,.12);
  outline:none;
}

/* æ·±è‰²ä¸»é¡Œï¼šè¼¸å…¥æ¡†èšç„¦ = ç§‘æŠ€è—å…‰ */
html[data-theme="dark"] input:focus,
html[data-theme="dark"] select:focus,
html[data-theme="dark"] textarea:focus{
  border-color:#60a5fa;
  box-shadow:
    0 0 0 2px rgba(96,165,250,.45),
    0 0 12px rgba(96,165,250,.35);
  outline:none;
}

/* äº®è‰²ä¸»é¡Œï¼šæŠŠã€Œå…¨ç³»çµ±å•Ÿå‹•ã€æŒ‰éˆ•æ”¹æˆ #D8C8A1 */
html[data-theme="light"] #boot{
  background:#D8C8A1;
  color:#1f2937;
  border:1px solid transparent;
}
html[data-theme="light"] #boot:hover{
  filter:brightness(.97);
}
/* äº®è‰²ä¸»é¡Œï¼šæŠŠã€Œå„²å­˜ã€æŒ‰éˆ•æ”¹æˆ #E7E4DB */
html[data-theme="light"] #save{
  background:#E7E4DB;
  color:#1f2937;
  border:1px solid transparent;
}
html[data-theme="light"] #save:hover{
  filter:brightness(.97);
}
/* æ·±è‰²ä¸»é¡Œä¸æ”¹ï¼Œæ²¿ç”¨åŸæœ¬ .btn-ghost æ¨£å¼ */
  </style>
</head>
<body>
<div class="wrap">
  <div class="hdr">
    <div class="brand">
      <h1>
        <img src="./logo.png"
         style="width:40px;height:40px;border-radius:4px;vertical-align:middle;margin-left:14px;">
        å§”è¨—æŸ¥è©¢å¹³å°
      </h1>
    </div>
    <div class="hdr-controls">
      <a class="btn-pill" style="text-decoration:none !important;"
         href="line://ti/p/@307momvl" target="_blank" rel="noopener">ğŸ’¬ LINEå®˜æ–¹</a>

      <button id="musicToggle" class="btn-pill" style="color: var(--text);">ğŸ”Š BGMéŸ³æ¨‚</button>
      <button id="themeToggle" class="theme-toggle">ğŸŒ“ BGä¸»é¡Œ</button>
    </div>
  </div>

  <div class="card">
    <div class="grid2">
      <label>API Base</label><input id="api" placeholder="https://xxx.onrender.com"/>
      <label>X-API-KEY</label><input id="key" placeholder="å¯ç•™ç™½"/>
      <label>æ¨¡å¼</label>
      <select id="mode"><option value="exact">exact</option><option value="fuzzy">fuzzy</option></select>
    </div>
    <div class="btn-row" style="margin-top:12px">
      <button class="btn-primary" id="boot">âš¡ å…¨ç³»çµ±å•Ÿå‹•</button>
      <button class="btn-ghost" id="save">ğŸ’¾ å„²å­˜</button>
      <span></span><span></span>
    </div>
  </div>

  <div class="card">
    <div class="grid2"><label>æŸ¥è©¢åœ°å€</label><input id="addr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚å—å±¯å€å¤§å¢©å—è·¯356è™Ÿ"/></div>
    <div class="btn-row">
      <button class="btn-primary" id="echo">Echo æ¸¬è©¦</button>
      <button class="btn-info" id="runCombo">åŸ·è¡Œ Combo</button>
      <button class="btn-stop" id="runBigfun">åƒ… BigFun</button>
      <button class="btn-close" id="abort" disabled>ä¸­æ­¢</button>
    </div>
    <label style="display:block;margin-top:12px;font-weight:800">æ—¥èªŒè¼¸å‡º</label>
    <textarea id="log" class="log" spellcheck="false" placeholder="é€™è£¡æœƒé¡¯ç¤ºä¸²æµæ—¥èªŒ..."></textarea>
  </div>
</div>

<audio id="bgm" loop src="https://www.christourlife.ca/images/music/instrumental-hymns-cd/03%20Be%20Still%20My%20Soul.mp3"></audio>

<div id="overlay" class="overlay" style="display:none">
  <div class="spinner" aria-label="loading"></div>
  <div class="overlay-msg">ğŸ§  æ™ºæ…§é€£ç·šä¸­ï¼Œè«‹ç¨å€™â€¦</div>
</div>
</div>

<script>
const $=id=>document.getElementById(id);
function logLine(t){const ta=$('log');ta.value+=(typeof t==='string'?t:JSON.stringify(t,null,2))+"\n";ta.scrollTop=ta.scrollHeight;}
function clearLog(){$('log').value='';}
const state={
  get api(){return localStorage.getItem('api')||''},set api(v){localStorage.setItem('api',v||'')},
  get key(){return localStorage.getItem('key')||''},set key(v){localStorage.setItem('key',v||'')},
  get mode(){return localStorage.getItem('mode')||'exact'},set mode(v){localStorage.setItem('mode',v)},
  get theme(){return localStorage.getItem('theme')||'light'},set theme(v){localStorage.setItem('theme',v)},
  get music(){return localStorage.getItem('music')||'on'},set music(v){localStorage.setItem('music',v)}
};
function headers(){const h={'Content-Type':'application/json'};const k=state.key?.trim();if(k)h['x-api-key']=k;return h;}
async function post(p,b){const u=(state.api||'').replace(/\/$/,'')+p;const r=await fetch(u,{method:'POST',headers:headers(),body:JSON.stringify(b||{})});if(!r.ok&&r.status!==202)throw new Error(r.status);return r.json();}
async function get(p){const u=(state.api||'').replace(/\/$/,'')+p;const r=await fetch(u,{headers:headers()});if(!r.ok)throw new Error(r.status);return r.text().catch(()=>r.statusText);}
$('themeToggle').onclick=()=>{state.theme=state.theme==='light'?'dark':'light';document.documentElement.setAttribute('data-theme',state.theme);};
/* ---------- Music Toggle ---------- */
const bgm=$('bgm');const btnMusic=$('musicToggle');let isPlaying=false;
function updateMusicButton(){btnMusic.textContent=isPlaying?'ğŸ”‡BGMéœéŸ³':'ğŸ”ŠBGMéŸ³æ¨‚';}
async function playMusic(){try{bgm.volume=.45;await bgm.play();isPlaying=true;state.music='on';updateMusicButton();}catch(e){console.warn('æ’­æ”¾è¢«ç€è¦½å™¨é˜»æ“‹ï¼Œè«‹å…ˆé»æ“Šé é¢å†è©¦');}}
function stopMusic(){bgm.pause();isPlaying=false;state.music='off';updateMusicButton();}
btnMusic.onclick=()=>{if(!isPlaying)playMusic();else stopMusic();};
if(state.music==='on'){playMusic();}else{stopMusic();}

function showOverlay(msg){const el=$('overlay');el.style.display='flex';if(msg)el.querySelector('.overlay-msg').textContent=msg;}
function hideOverlay(){$('overlay').style.display='none';}
$('save').onclick=()=>{state.api=$('api').value;state.key=$('key').value;state.mode=$('mode').value;logLine("âœ… è¨­å®šå·²å„²å­˜");};

/* âœ… å…¨ç³»çµ±å•Ÿå‹• */
$('boot').onclick=async()=>{
  clearLog();showOverlay('ğŸ§  æ™ºæ…§é€£ç·šä¸­ï¼Œè«‹ç¨å€™â€¦');
  try{
    const base=(state.api||'').replace(/\/$/,'');
    const h=await fetch(base+'/health').then(r=>r.text()).catch(e=>String(e));
    logLine('ğŸ’¡ å·²é€£æ¥é›²ç«¯ä»£ç†ï¼š'+h);
    const r=await fetch(base+'/api/start-all',{method:'POST',headers:headers()});
    const text=await r.text();let d;try{d=JSON.parse(text);}catch{d={ok:false,error:text};}
    if(d.error)logLine('âŒ '+d.error);else{
      logLine('ğŸ§  å•Ÿå‹•ï¼š'+(d.ok?'OK':'FAIL'));
      logLine('ğŸ’¡ CBSï¼š'+(d.cbs||'æœªçŸ¥'));
      logLine('ğŸ’¡ BigFunï¼š'+(d.bigfun||'æœªçŸ¥'));
      logLine('ğŸŒ ç³»çµ±å°±ç·’');
    }
  }catch(e){logLine('âŒ '+(e?.message||e));}
  finally{setTimeout(()=>hideOverlay(),800);}
};

function toClean(t){if(!t)return'æœªçŸ¥';t=t.toLowerCase();if(t.includes('ok'))return'OK';if(t.includes('fail')||t.includes('error'))return'å¤±æ•—';return t.replace(/<[^>]+>/g,'');}
function parseAddress(a){const s=a.replace(/è‡º/g,'å°').replace(/\s+/g,'');const c=s.match(/^(å°åŒ—å¸‚|æ–°åŒ—å¸‚|æ¡ƒåœ’å¸‚|å°ä¸­å¸‚|å°å—å¸‚|é«˜é›„å¸‚|åŸºéš†å¸‚|æ–°ç«¹å¸‚|å˜‰ç¾©å¸‚|æ–°ç«¹ç¸£|è‹—æ —ç¸£|å½°åŒ–ç¸£|å—æŠ•ç¸£|é›²æ—ç¸£|å˜‰ç¾©ç¸£|å±æ±ç¸£|å®œè˜­ç¸£|èŠ±è“®ç¸£|å°æ±ç¸£)/);const city=c?c[1]:'';let r=s.slice(city.length);const t=r.match(/^(.+?[å¸‚å€é„‰é®])/);const town=t?t[1]:'';r=r.slice(town.length);const rd=r.match(/^(.+?(?:è·¯|è¡—|å¤§é“)(?:[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å0-9]+æ®µ)?)/);const road=rd?rd[1]:'';r=r.slice(road.length);const lane=(r.match(/(\d+)å··/)||[, ''])[1];const alley=(r.match(/(\d+)å¼„/)||[, ''])[1];const num=(r.match(/(\d+(?:-\d+)?)è™Ÿ/)||[, ''])[1];const floor=(r.match(/(\d+)æ¨“/)||[, ''])[1];return{city,town,road,lane,alley,num,floor};}

$('echo').onclick=async()=>{clearLog();const p=parseAddress($('addr').value);try{
  const c=toClean(await get('/api/check-cbs').catch(e=>String(e)));
  const b=toClean(await get('/api/check-bigfun').catch(e=>String(e)));
  logLine(`CBSï¼š${c}`);logLine(`BigFunï¼š${b}`);logLine(`åœ°å€è§£æï¼š${JSON.stringify(p)}`);
}catch(e){logLine('âŒ '+(e?.message||e));}};

async function pollJob(id,label){logLine(`ï¼»${label}ï¼½ä»»å‹™å»ºç«‹ï¼š${id}`);for(;;){await new Promise(r=>setTimeout(r,2000));let j;try{j=await fetch((state.api||'').replace(/\/$/,'')+'/api/jobs/'+id,{headers:headers()}).then(r=>r.json())}catch{j=null}if(!j){logLine('ä»»å‹™ä¸å­˜åœ¨');return;}if(j.status==='done'){const r=j.result||{};logLine(`åœ°è™Ÿï¼š${r.landNo||''}`);logLine(`å»ºè™Ÿï¼š${r.buildNoFull||''}`);if(r.entrust)logLine(`å§”è¨—ï¼š${r.entrust}`);return;}if(j.status==='error'){logLine(`å¤±æ•—ï¼š${j.error}`);return;}logLine('â€¦è™•ç†ä¸­');}}

$('runBigfun').onclick=async()=>{clearLog();try{const r=await post('/api/run-bigfun',{address:$('addr').value.trim()});await pollJob(r.jobId,'BigFun');}catch(e){logLine('âŒ '+e);}};
$('runCombo').onclick=async()=>{clearLog();try{const r=await post('/api/run-combo',{address:$('addr').value.trim(),mode:state.mode});await pollJob(r.jobId,'Combo');}catch(e){logLine('âŒ '+e);}};
$('abort').onclick=()=>logLine('ï¼ˆèƒŒæ™¯ä»»å‹™ï¼Œç„¡æ³•ä¸­æ­¢ï¼‰');
</script>
</body>
</html>
