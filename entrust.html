<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBS Agent 控制台</title>
  <style>
    :root{
      --bg:#f7f7f5; --panel:#ffffff; --muted:#6b7280; --text:#0a1a3f;
      --primary:#1e3a8a; --border:#e5e7eb; --code:#f3f4f6;
      --ok:#16a34a; --bad:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.58 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    .wrap{max-width:760px;margin:18px auto 28px;padding:0 12px}
    .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .hdr h2{margin:0;font-size:18px;font-weight:800}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 4px 12px rgba(2,6,23,.06);margin-bottom:12px}
    label{display:block;margin:4px 0 6px;font-weight:700;font-size:13px}
    input,select{width:62%;padding:10px 12px;background:#fafafa;color:var(--text);border:1px solid var(--border);border-radius:10px;outline:none}
    input:focus,select:focus{border-color:#93c5fd;box-shadow:0 0 0 3px #dbeafe}
    .pair{display:flex;gap:10px;align-items:center;flex-wrap:nowrap}
    .btn-row{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:8px;margin-top:10px}
    button{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn-start{background:#1e3a8a;color:#fff}
    .btn-info{background:#e0e7ff;color:#1e293b;border:1px solid #c7d2fe}
    .btn-stop{background:#f3f4f6;color:#111827;border:1px solid var(--border)}
    .btn-close{background:#111827;color:#fff}
    .badge{display:inline-flex;align-items:center;justify-content:center;height:20px;padding:0 8px;border-radius:999px;font-weight:700;font-size:12px}
    .ok{background:#ecfdf5;color:var(--ok);border:1px solid #bbf7d0}
    .bad{background:#fef2f2;color:var(--bad);border:1px solid #fecaca}
    .muted{background:#eef2ff;color:#475569;border:1px solid #e2e8f0}
    .log{white-space:pre-wrap;overflow:auto;background:var(--code);border:1px solid var(--border);border-radius:10px;padding:12px;min-height:420px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr"><h2>🏠 CBS Agent 控制台</h2></div>

    <div class="card">
      <div class="pair">
        <label>API Base</label>
        <input id="api" placeholder="例如 https://cbs-agent-docker.onrender.com" />
      </div>
      <div class="pair" style="margin-top:6px">
        <label>X-API-KEY</label>
        <input id="key" placeholder="可留白" />
      </div>
      <div class="pair" style="margin-top:6px;align-items:center">
        <label>模式</label>
        <select id="mode">
          <option value="exact">exact（精準）</option>
          <option value="fuzzy">fuzzy（寬鬆）</option>
        </select>
        <span id="healthStat" class="badge muted">未知</span>
      </div>
      <div class="pair" style="margin-top:10px;gap:8px">
        <button class="btn-stop" id="save">💾 儲存</button>
        <button class="btn-info" id="ping">🔎 健康檢查</button>
      </div>
    </div>

    <div class="card">
      <div class="pair">
        <label>查詢地址</label>
        <input id="addr" placeholder="例：台中市南屯區大墩南路356號" style="flex:1" />
      </div>
      <div class="btn-row">
        <button class="btn-start" id="echo">Echo 測試</button>
        <button class="btn-info" id="runCombo">執行 Combo</button>
        <button class="btn-stop" id="runBigfun">僅 BigFun</button>
        <button class="btn-close" id="abort" disabled>中止</button>
      </div>
      <label style="margin-top:10px">日誌輸出</label>
      <textarea id="log" class="log" spellcheck="false" placeholder="這裡會顯示串流日誌..."></textarea>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const state = {
  get api(){ return localStorage.getItem('api') || '' },
  set api(v){ localStorage.setItem('api', v||'') },
  get key(){ return localStorage.getItem('key') || '' },
  set key(v){ localStorage.setItem('key', v||'') },
  get mode(){ return localStorage.getItem('mode') || 'exact' },
  set mode(v){ localStorage.setItem('mode', v||'exact') },
};

(function init(){ $('api').value=state.api; $('key').value=state.key; $('mode').value=state.mode; })();
function appendLog(t){ const ta=$('log'); ta.value += t; ta.scrollTop=ta.scrollHeight; }
function clearLog(){ $('log').value=''; }

function headers(){
  const h={'Content-Type':'application/json'};
  const k=(state.key||'').trim(); if(k) h['x-api-key']=k;
  return h;
}
async function post(path, body){
  const base=(state.api||'').replace(/\/$/,'');
  const r = await fetch(base+path, { method:'POST', headers:headers(), body: JSON.stringify(body||{}) });
  const txt = await r.text();
  let j = null; try{ j = JSON.parse(txt); }catch{}
  return { status:r.status, json:j, text:txt };
}
async function get(path){
  const base=(state.api||'').replace(/\/$/,'');
  const r = await fetch(base+path, { headers:headers() });
  const txt = await r.text();
  let j = null; try{ j = JSON.parse(txt); }catch{}
  return { status:r.status, json:j, text:txt };
}
async function pollJob(jobId){
  for(let i=0;i<180;i++){ // 最多 3 分鐘
    const r = await get('/api/jobs/'+jobId);
    if (r.json && (r.json.status==='done' || r.json.status==='error')) return r.json;
    await new Promise(r=>setTimeout(r,1000));
  }
  return { status:'error', error:'poll timeout' };
}

$('save').onclick = ()=>{ state.api=$('api').value; state.key=$('key').value; state.mode=$('mode').value; };

$('ping').onclick = async()=>{
  clearLog(); appendLog('檢查健康狀態...\n');
  try{
    const r = await fetch((state.api||'').replace(/\/$/,'')+'/health');
    const t = await r.text(); appendLog(t+'\n');
  }catch(e){ appendLog('health 失敗：'+e.message+'\n'); }
};

$('echo').onclick = async()=>{
  clearLog(); appendLog('Echo 測試中...\n');
  try{
    const r = await post('/api/echo-address', { address:$('addr').value });
    const d = r.json || {};
    appendLog('CBS登入：'+(d?.cbs?.ok?'OK':'未知/否')+'\n');
    appendLog('BigFun登入：'+(d?.bigfun?.ok?'OK':'未知/否')+'\n');
    appendLog('地址解析：'+JSON.stringify(d?.parts||{})+'\n');
  }catch(e){ appendLog('echo 失敗：'+e.message+'\n'); }
};

$('runBigfun').onclick = async()=>{
  clearLog(); appendLog('執行 BigFun...\n');
  const r = await post('/api/run-bigfun', { address:$('addr').value });
  if (r.status===202 && r.json?.jobId){
    appendLog(`[job] ${r.json.jobId} 建立，開始輪詢...\n`);
    const j = await pollJob(r.json.jobId);
    if (j.status==='done'){
      const resp = j.response || {};
      appendLog('=== BigFun 結果 ===\n');
      appendLog('狀態：'+(resp.ok?'成功':'失敗/部分成功')+'\n');
      appendLog('地號：'+(resp.landNo||'')+'\n');
      appendLog('建號：'+(resp.buildNoFull||'')+'\n');
    } else {
      appendLog('BigFun 失敗：'+(j.error||'unknown')+'\n');
    }
  } else {
    const d = r.json || {};
    appendLog('=== BigFun 結果 ===\n');
    appendLog('狀態：'+(d.ok?'成功':'失敗/部分成功')+'\n');
    appendLog('地號：'+(d.landNo||'')+'\n');
    appendLog('建號：'+(d.buildNoFull||'')+'\n');
  }
};

$('runCombo').onclick = async()=>{
  clearLog(); appendLog('執行 Combo...\n');
  const payload = { address:$('addr').value, mode: state.mode, verify:'', lineOfficial:false };
  const r = await post('/api/run-combo', payload);
  if (r.status===202 && r.json?.jobId){
    appendLog(`[job] ${r.json.jobId} 建立，開始輪詢...\n`);
    const j = await pollJob(r.json.jobId);
    if (j.status==='done'){
      const resp = j.response || {};
      appendLog('=== Combo 結果 ===\n');
      appendLog('狀態：'+(resp.ok?'成功':'失敗/部分成功')+'\n');
      appendLog('地號：'+(resp.landNo||'')+'\n');
      appendLog('建號：'+(resp.buildNoFull||'')+'\n');
      appendLog('委託：'+(resp.entrust||'')+'\n');
    } else {
      appendLog('Combo 失敗：'+(j.error||'unknown')+'\n');
    }
  } else {
    const d = r.json || {};
    appendLog('=== Combo 結果 ===\n');
    appendLog('狀態：'+(d.ok?'成功':'失敗/部分成功')+'\n');
    appendLog('地號：'+(d.landNo||'')+'\n');
    appendLog('建號：'+(d.buildNoFull||'')+'\n');
    appendLog('委託：'+(d.entrust||'')+'\n');
  }
};

$('abort').onclick = ()=>{ appendLog('（火線版暫無 abort）\n'); };
</script>
</body>
</html>
