<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CBS Agent æ§åˆ¶å°</title>
  <style>
    body{margin:0;background:#f7f7f5;color:#0a1a3f;font:14px/1.58 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    .wrap{max-width:760px;margin:18px auto 28px;padding:0 12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:14px;box-shadow:0 4px 12px rgba(2,6,23,.06);margin-bottom:12px}
    label{display:block;margin:4px 0 6px;font-weight:700;font-size:13px}
    input,select{width:62%;padding:10px 12px;background:#fafafa;border:1px solid #e5e7eb;border-radius:10px;outline:none}
    .btn-row{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:10px}
    button{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn-start{background:#1e3a8a;color:#fff}.btn-info{background:#e0e7ff;color:#1e293b;border:1px solid #c7d2fe}
    .btn-stop{background:#f3f4f6;color:#111827;border:1px solid #e5e7eb}.btn-close{background:#111827;color:#fff}
    .badge{display:inline-flex;align-items:center;justify-content:center;height:20px;padding:0 8px;border-radius:999px;font-weight:700;font-size:12px;line-height:1}
    .ok{background:#ecfdf5;color:#16a34a;border:1px solid #bbf7d0}.bad{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}.muted{background:#eef2ff;color:#475569;border:1px solid #e2e8f0}
    .log{white-space:pre-wrap;overflow:auto;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:12px;min-height:420px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="pair">
        <label>API Base</label>
        <input id="api" placeholder="ä¾‹å¦‚ https://cbs-agent-docker.onrender.com" />
      </div>
      <div class="pair" style="margin-top:6px">
        <label>X-API-KEY</label>
        <input id="key" placeholder="å¯ç•™ç™½" />
      </div>
      <div class="pair" style="margin-top:6px;display:flex;align-items:center;gap:8px">
        <label>æ¨¡å¼</label>
        <select id="mode">
          <option value="exact">exactï¼ˆç²¾æº–ï¼‰</option>
          <option value="fuzzy">fuzzyï¼ˆå¯¬é¬†ï¼‰</option>
        </select>
        <span id="healthStat" class="badge muted">æœªçŸ¥</span>
      </div>
      <div class="pair" style="margin-top:10px;gap:8px;display:flex">
        <button class="btn-stop" id="save">ğŸ’¾ å„²å­˜</button>
        <button class="btn-info" id="ping">ğŸ” å¥åº·æª¢æŸ¥</button>
      </div>
    </div>

    <div class="card">
      <div class="pair">
        <label>æŸ¥è©¢åœ°å€</label>
        <input id="addr" placeholder="ä¾‹ï¼šå°ä¸­å¸‚å—å±¯å€å¤§å¢©å—è·¯356è™Ÿ" style="width:100%" />
      </div>
      <div class="btn-row">
        <button class="btn-start" id="echo">Echo æ¸¬è©¦</button>
        <button class="btn-info" id="runCombo">åŸ·è¡Œ Combo</button>
        <button class="btn-stop" id="runBigfun">åƒ… BigFun</button>
        <button class="btn-close" id="abort">ä¸­æ­¢</button>
      </div>
      <label style="margin-top:10px">æ—¥èªŒè¼¸å‡º</label>
      <textarea id="log" class="log" spellcheck="false" placeholder="é€™è£¡æœƒé¡¯ç¤ºæ—¥èªŒ..."></textarea>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const qs = new URLSearchParams(location.search);

  const state = {
    get api(){ return localStorage.getItem('api') || '' },
    set api(v){ localStorage.setItem('api', v || '') },
    get key(){ return localStorage.getItem('key') || '' },
    set key(v){ localStorage.setItem('key', v || '') },
    get mode(){ return localStorage.getItem('mode') || 'exact' },
    set mode(v){ localStorage.setItem('mode', v || 'exact') },
  };

  function appendLog(t){ const ta=$('log'); ta.value += t; ta.scrollTop = ta.scrollHeight }
  function clearLog(){ $('log').value='' }
  function badge(el, kind, text){ el.className = 'badge ' + (kind||'muted'); el.textContent = text }

  // è®€ URL åƒæ•¸ï¼ˆè¦†è“‹æœ¬åœ°ï¼‰
  const urlApi = qs.get('api'); if (urlApi) state.api = urlApi;
  const urlKey = qs.get('key'); if (urlKey) state.key = urlKey;

  // åˆå§‹åŒ– UI
  $('api').value = state.api; $('key').value = state.key; $('mode').value = state.mode;

  // è‹¥æ²’æœ‰ apiï¼Œå˜—è©¦å‘ Render /config è®€å–
  (async function hydrateFromRender(){
    if (state.api) return;
    try{
      // é€™å€‹è·¯å¾‘å°±æ˜¯ Render å°ˆæ¡ˆå…¬é–‹åŸŸå
      const renderBase = 'https://cbs-agent-docker.onrender.com';
      const r = await fetch(renderBase + '/config', { cache: 'no-store' });
      const cfg = await r.json();
      if (cfg?.apiBase) {
        state.api = cfg.apiBase;
        $('api').value = state.api;
        console.log('[config] apiBase from Render:', cfg.apiBase);
      }
    }catch(e){
      console.warn('[config] è®€å– Render /config å¤±æ•—ï¼š', e?.message || e);
    }
  })();

  function headers(){
    const h = { 'Content-Type':'application/json' };
    const k = (state.key || $('key').value || '').trim();
    if (k) h['x-api-key'] = k;
    return h;
  }

  async function doFetch(path, opts={}){
    const base = (state.api || $('api').value || '').trim().replace(/\/$/, '');
    if (!base) throw new Error('å°šæœªè¨­å®š API Base');
    const res = await fetch(base + path, { ...opts, headers: { ...(opts.headers||{}), ...headers() } });
    if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return res;
  }

  $('save').onclick = ()=>{
    state.api  = $('api').value;
    state.key  = $('key').value;
    state.mode = $('mode').value;
    appendLog('[saved] è¨­å®šå·²å„²å­˜\n');
  };

  $('ping').onclick = async()=>{
    clearLog(); appendLog('æª¢æŸ¥å¥åº·ç‹€æ…‹...\n');
    badge($('healthStat'), 'muted', 'æª¢æŸ¥ä¸­');
    try{
      const r = await doFetch('/health', { method:'GET' });
      const t = await r.text();
      appendLog(t + '\n'); badge($('healthStat'), 'ok', 'OK');
    }catch(e){
      appendLog('health å¤±æ•—ï¼š' + e.message + '\n'); badge($('healthStat'), 'bad', 'å¤±æ•—');
    }
  };

  $('echo').onclick = async()=>{
    clearLog(); appendLog('Echo æ¸¬è©¦ä¸­...\n');
    try{
      const res = await doFetch('/api/echo-address', {
        method:'POST', body: JSON.stringify({ address: $('addr').value })
      });
      appendLog(JSON.stringify(await res.json(), null, 2) + '\n');
    }catch(e){ appendLog(e.message+'\n'); }
  };

  // å»ºç«‹ job ä¸¦è¼ªè©¢
  async function startJob(kind, payload){
    const res = await doFetch('/api/' + kind, { method:'POST', body: JSON.stringify(payload||{}) });
    const j = await res.json();
    if (!j?.jobId) throw new Error('job å»ºç«‹å¤±æ•—');
    appendLog(`[job] ${j.jobId} å»ºç«‹ï¼Œé–‹å§‹è¼ªè©¢...\n`);
    // è¼ªè©¢
    while(true){
      await new Promise(r=>setTimeout(r, 1500));
      const s = await doFetch('/api/jobs/' + j.jobId, { method:'GET' }).then(r=>r.json());
      if (s.status === 'pending'){
        appendLog('.');
        continue;
      }
      appendLog('\n');
      if (s.status === 'done'){
        if (s.result?.raw) appendLog(String(s.result.raw) + '\n');
        else appendLog(JSON.stringify(s.result, null, 2) + '\n');
      } else {
        appendLog('[error] ' + (s.error || 'unknown') + '\n');
      }
      break;
    }
  }

  $('runBigfun').onclick = async()=>{
    clearLog(); appendLog('åŸ·è¡Œ BigFun...\n');
    try{
      await startJob('run-bigfun', { address: $('addr').value, show:'0' });
    }catch(e){ appendLog(e.message+'\n'); }
  };

  $('runCombo').onclick = async()=>{
    clearLog(); appendLog('åŸ·è¡Œ Combo...\n');
    try{
      await startJob('run-combo', {
        address: $('addr').value,
        mode: $('mode').value,
        verify: '',
        lineOfficial: false
      });
    }catch(e){ appendLog(e.message+'\n'); }
  };

  $('abort').onclick = async()=>{
    // è‹¥ä½ çš„æ¡Œæ©Ÿæœ‰ /api/abortï¼Œå°±æœƒç«‹å³è½‰ç™¼ï¼›æ²’æœ‰å°±ç•¥é
    try{
      const r = await doFetch('/api/abort', { method:'POST', body: JSON.stringify({}) });
      appendLog((await r.text()) + '\n');
    }catch(e){ appendLog(e.message+'\n'); }
  };
})();
</script>
</body>
</html>
