/* == 多功能刪文助手 v1.9（書籤版：桌機/手機） =======================
   - 改版重點：移除 loader popup，改為 直接 confirm → 取 core
   - 流程：invite(3m) → confirm(驗證檢核碼，寫 Notion) → token(15m) → core
   - 隱藏 DEV 模式：輸入檢核碼 DEV 才顯示 DEV 區塊
   - 日誌精簡：開始／商城掃描…／🗑️ 已刪除／⛔ 跳過：原因／🟠 已要求停止
==================================================================== */
(()=>{
  // ==== 依你服務網域調整這三個常數（Render 部署後的完整網址）====
  const INVITE_URL         = 'https://verify-web.onrender.com/auth/mintInvite';
  const VERIFY_CONFIRM_URL = 'https://verify-web.onrender.com/api/verify/confirm';
  const CORE_API_BASE      = 'https://verify-web.onrender.com/api/core?c=';

  const PANEL_ID = 'fb_del_flagship_panel_v19';

  // 先移除舊面板（含 v1.8）
  (['fb_del_flagship_panel_v14','fb_del_flagship_panel_v15','fb_del_flagship_panel_v16','fb_del_flagship_panel_v16m0','fb_del_flagship_panel_v18',PANEL_ID])
    .forEach(id=>{ const el=document.getElementById(id); if(el) try{el.remove();}catch{} });

  // ===== style =====
  const css=`
  #${PANEL_ID}{position:fixed;right:14px;top:68px;z-index:2147483000;width:320px;background:#0B1220;color:#E5E7EB;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.35);font:14px/1.4 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial;border:1px solid #192233;user-select:none}
  #${PANEL_ID} .hdr{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid #182133;cursor:move}
  #${PANEL_ID} .ttl{font-weight:700;font-size:16px}
  #${PANEL_ID} .min{margin-left:auto;background:#0b1220;border:1px solid #243041;color:#9ca3af;border-radius:8px;padding:4px 8px;cursor:pointer;user-select:none}
  #${PANEL_ID} .box{padding:10px 12px 12px}
  #${PANEL_ID} label{display:block;margin:8px 0 4px;color:#9fb0c3;font-size:12px}
  #${PANEL_ID} input,#${PANEL_ID} select, #${PANEL_ID} textarea{width:100%;box-sizing:border-box;padding:8px;border-radius:10px;border:1px solid #374151;background:#111827;color:#E5E7EB;outline:none;user-select:text}
  #${PANEL_ID} textarea{height:140px;font:12px/1.4 ui-monospace,SFMono-Regular,Menlo,monospace}
  #${PANEL_ID} .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  #${PANEL_ID} input[type="date"]{background:#fff;color:#111827;border:1px solid #374151;border-radius:10px;padding:8px}
  #${PANEL_ID} input[type="date"]::-webkit-calendar-picker-indicator{filter:none;opacity:.85}
  #${PANEL_ID} .lineRow{display:grid;grid-template-columns:1fr 100px;gap:10px;margin-top:10px;align-items:center}
  #${PANEL_ID} .lineTag{height:40px;display:flex;align-items:center;padding:0 10px;background:#0b1220;border:1px solid #243041;color:#9cc1ff;border-radius:10px}
  #${PANEL_ID} .lineBtn{height:40px;border:none;border-radius:10px;background:#2563eb;color:#fff;cursor:pointer;font-weight:700}
  #${PANEL_ID} .hint{font-size:12px;color:#9fb0c3;margin-top:6px}
  #${PANEL_ID} .now{margin-top:6px;color:#60a5fa;font-size:12px}
  #${PANEL_ID} .btns{display:grid;grid-template-columns:1fr 1fr 100px;gap:10px;margin:12px 0 8px}
  #${PANEL_ID} .btn{border:none;border-radius:10px;padding:10px;cursor:pointer;font-weight:700}
  #${PANEL_ID} .green{background:#10b981;color:#062a22}
  #${PANEL_ID} .yellow{background:#f59e0b;color:#1f2937}
  #${PANEL_ID} .dark{background:#1f2937;color:#cbd5e1}
  #${PANEL_ID} .log{height:110px;overflow:auto;background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:8px 10px;margin:8px 0 12px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;font-size:12px;white-space:pre-wrap}
  #${PANEL_ID} details{margin-top:8px}
  #${PANEL_ID} summary{cursor:pointer;color:#9cc1ff}
  `;
  const st=document.createElement('style'); st.textContent=css; document.head.appendChild(st);

  // ===== DOM =====
  const wrap=document.createElement('div'); wrap.id=PANEL_ID;
  wrap.innerHTML=`
    <div class="hdr" id="dragHdr">
      <div class="ttl">刪文助手 v1.9</div>
      <button class="min" id="minBtn">最小化</button>
    </div>
    <div class="box" id="bodyBox">

      <label>檢核碼（必填）</label>
      <input id="passcode" placeholder="請貼上從官網取得的檢核碼；輸入 DEV 可開啟備援">

      <label>模式</label>
      <select id="mode">
        <option value="group">社團貼文</option>
        <option value="shop">商城貼文</option>
      </select>

      <label id="nameLabel">你的名字</label>
      <input id="name" placeholder="與貼文顯示一致的名稱">

      <div class="row">
        <div><label>每輪上限</label><input id="limit" type="number" min="1" value="10"></div>
        <div><label>捲動次數</label><input id="scrolls" type="number" min="1" value="3"></div>
      </div>

      <div class="row">
        <div><label>延遲(ms)・min</label><input id="dmin" type="number" min="200" value="1000"></div>
        <div><label>延遲(ms)・max</label><input id="dmax" type="number" min="300" value="2000"></div>
      </div>

      <label>僅刪除此日期以前</label>
      <input id="cutoff" type="date" placeholder="年 / 月 / 日">

      <div class="now" id="nowTime"></div>

      <div class="lineRow">
        <div class="lineTag">官方 LINE：@307momvl</div>
        <button class="lineBtn" id="openLine">開啟</button>
      </div>

      <div class="btns">
        <button class="btn green" id="start">開始</button>
        <button class="btn yellow" id="stop">停止</button>
        <button class="btn dark" id="close">關閉</button>
      </div>

      <div class="log" id="log"></div>

      <!-- DEV 備援：預設隱藏；只有 DEBUG 才顯示 -->
      <details id="devBox" style="display:none;">
        <summary>DEV 模式：手動貼上核心（主機不可用時）</summary>
        <div class="hint">請將 <b>real-core.js</b> 全文貼在下面，再按「注入並開始」。只在本機執行，不會上傳。</div>
        <textarea id="devCore" placeholder="// 貼上 real-core.js 內容…"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button class="btn dark" id="devInject">注入並開始</button>
        </div>
      </details>
    </div>
  `;
  document.body.appendChild(wrap);

  // ===== helpers =====
  const $=s=>wrap.querySelector(s);
  const logBox=$('#log');
  const log=(...a)=>{ logBox.textContent+=a.join(' ')+'\n'; logBox.scrollTop=logBox.scrollHeight; };

  const pad=n=>String(n).padStart(2,'0');
  function tick(){ const d=new Date(); $('#nowTime').textContent=`現在時間：${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; }
  tick(); const clock=setInterval(tick,1000);

  // === DEBUG（隱藏 DEV） ===
  let DEBUG = false;
  function setDebug(on){
    DEBUG = !!on;
    try { localStorage.setItem('FBDEL_DEBUG', DEBUG ? '1':'0'); } catch {}
    const box = document.getElementById('devBox');
    if (box) box.style.display = DEBUG ? 'block' : 'none';
    try { log('🔧 DEBUG =', DEBUG ? 'ON' : 'OFF'); } catch{}
  }
  try { if (localStorage.getItem('FBDEL_DEBUG')==='1') setDebug(true); } catch{}

  // 最小化 / 關閉 / 開 LINE
  $('#minBtn').onclick=()=>{ const b=$('#bodyBox'); const hide=b.style.display!=='none'; b.style.display=hide?'none':'block'; $('#minBtn').textContent=hide?'展開':'最小化'; };
  $('#close').onclick=()=>{ try{clearInterval(clock);}catch{} wrap.remove(); };
  $('#openLine').onclick=()=>window.open('https://line.me/R/ti/p/@307momvl','_blank');

  // 可拖曳（桌機/手機）
  (function enableDrag(){
    const hdr=$('#dragHdr'); let sx=0,sy=0,ox=0,oy=0,dragging=false;
    hdr.addEventListener('pointerdown',e=>{ if(e.target.closest('button'))return; dragging=true; hdr.setPointerCapture(e.pointerId); sx=e.clientX; sy=e.clientY; const r=wrap.getBoundingClientRect(); ox=r.left; oy=r.top; e.preventDefault(); });
    hdr.addEventListener('pointermove',e=>{ if(!dragging)return; const dx=e.clientX-sx, dy=e.clientY-sy; wrap.style.left=Math.max(0,ox+dx)+'px'; wrap.style.top=Math.max(0,oy+dy)+'px'; wrap.style.right='auto'; wrap.style.bottom='auto'; wrap.style.position='fixed'; });
    const end=()=>{ dragging=false; }; hdr.addEventListener('pointerup',end); hdr.addEventListener('pointercancel',end);
  })();

  // 預填名字（社團）
  try{
    const guess=Array.from(document.querySelectorAll('a[aria-label$="的動態時報"], a[aria-label*="profile"], a[role="link"] span.html-span'))
      .map(e=>e.textContent?.trim()).find(s=>s && s.length<=50);
    if(guess) $('#name').value=guess;
  }catch{}

  // 停止旗標
  let abortFlag=false;
  $('#stop').onclick=()=>{ abortFlag=true; log('🟠 已要求停止'); };

  // 模式切換：名字/關鍵字提示
  function updateModeUI(){
    const m=$('#mode').value;
    if(m==='shop'){ $('#nameLabel').textContent='商品關鍵字（可多個：逗號 / 空白 / 換行 分隔）'; $('#name').placeholder='例：潭子 好市多 三房'; }
    else { $('#nameLabel').textContent='你的名字'; $('#name').placeholder='與貼文顯示一致的名稱'; }
  }
  $('#mode').addEventListener('change',updateModeUI); updateModeUI();

  // ---- 將核心字串注入成可呼叫的函式 ----
  function injectCoreCode(code) {
    return new Promise((res, rej) => {
      try {
        const blob = new Blob([code], { type: 'text/javascript' });
        const u = URL.createObjectURL(blob);
        const s = document.createElement('script');
        s.src = u;
        s.onload = () => {
          URL.revokeObjectURL(u);
          const coreFn =
            window.FB_DELETE_CORE ||
            (window.FBDelCore && typeof window.FBDelCore.start === 'function'
              ? (opts)=>window.FBDelCore.start(opts)
              : null);
          if (!coreFn) return rej(new Error('核心格式不正確'));
          res(coreFn);
        };
        s.onerror = () => { URL.revokeObjectURL(u); rej(new Error('Blob 腳本載入失敗')); };
        document.head.appendChild(s);
      } catch (e) { rej(e); }
    });
  }

  // ---- 直接 confirm → 核心 ----
  function genIdem(){
    return (crypto?.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2)+Date.now();
  }

  async function fetchCoreDirect(passcode){
    // 1) 先拿邀請票（3 分鐘）
    const r0 = await fetch(INVITE_URL, { method:'POST' });
    if(!r0.ok) throw new Error('邀請票取得失敗：HTTP '+r0.status);
    const inv = await r0.json();
    if(!inv || !inv.invite) throw new Error('邀請票無效');

    // 2) confirm 檢核碼 → 產生短效 token（15 分鐘）並寫回 Notion
    const body = {
      code: passcode.trim(),
      version: 'v1.9',
      referrer: location.href,
      idempotencyKey: genIdem(),
      userAgent: navigator.userAgent
    };
    const r1 = await fetch(VERIFY_CONFIRM_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+inv.invite },
      body: JSON.stringify(body)
    });
    if(!r1.ok) throw new Error('驗證伺服器連線失敗：HTTP '+r1.status);
    const v = await r1.json();
    if(!v || !v.ok || !v.token){
      const msg = (v && (v.error||v.message)) || '驗證碼無效或已過期';
      throw new Error(msg);
    }

    // 3) 用 token 去拿核心
    const r2 = await fetch(CORE_API_BASE + encodeURIComponent(v.token), { cache:'no-store', mode:'cors', credentials:'omit' });
    if(!r2.ok) throw new Error('核心伺服器連線失敗：HTTP '+r2.status);
    const data = await r2.json();
    if(data.error) throw new Error(data.error);
    if(!data || !data.code) throw new Error('伺服器未回核心程式');

    // 4) 注入核心
    return await injectCoreCode(data.code);
  }

  // ---- 組參數並執行核心 ----
  async function runCore(coreFn){
    const mode=$('#mode').value;
    const raw=$('#name').value.trim();
    const cutoff=$('#cutoff').value ? new Date($('#cutoff').value+'T23:59:59') : null;
    if(!raw){ alert(mode==='shop'?'請先輸入商品關鍵字':'請先輸入你的名字'); return; }

    const opts={
      mode,
      myName:(mode==='group')?raw:undefined,
      shopKeywords:(mode==='shop')?raw.split(/[\s,，]+/).map(s=>s.trim()).filter(Boolean):undefined,
      maxDelete:Math.max(1, +$('#limit').value || 10),
      maxScrollRounds:Math.max(1, +$('#scrolls').value || 3),
      delayMin:Math.max(200, +$('#dmin').value || 1000),
      delayMax:Math.max(+$('#dmax').value || 2000, +$('#dmin').value || 1000),
      cutoff,
      onLog: msg=>log(msg),
      shouldAbort: ()=>abortFlag,
      logMode:'simple',
      consoleEcho:false
    };

    log('開始');
    try{ await coreFn(opts); }catch(e){ log('⛔ 跳過：執行錯誤（',e.message,')'); }
  }

  // 🔘 開始（移除 loader；直接 confirm → core）
  $('#start').onclick=async()=>{
    abortFlag=false;
    const passcode=$('#passcode').value.trim();

    // DEV 暗門
    if(/^dev$/i.test(passcode)) { setDebug(true); log('🔧 已開啟 DEV 模式'); }

    // 強制需要檢核碼
    if(!passcode || /^dev$/i.test(passcode)) { alert('請先輸入檢核碼（從官網領取）。'); return; }

    try{
      const core = await fetchCoreDirect(passcode);
      await runCore(core);
    }catch(e){
      log('⛔ 跳過：核心未載入（', e.message, '）');
      if(/邀請票|驗證|核心|invalid|expired|not_found/i.test(e.message)){
        log('ℹ️ 提示：請回官網重新取得檢核碼，或稍後再試');
      }
      if(DEBUG){
        const box = $('#devBox'); box.style.display='block'; try{ box.open = true; }catch{}; $('#devCore').focus();
        log('🔧 DEBUG 開啟：已顯示 DEV 備援區塊');
      }
    }
  };

  // DEV 手動注入
  $('#devInject').onclick = async ()=>{
    const code = $('#devCore').value;
    if(!code || !code.trim()){ alert('請先貼上 core 內容'); return; }
    try{
      const core = await injectCoreCode(code);
      await runCore(core);
    }catch(e){
      log('⛔ 跳過：DEV 注入失敗（', e.message, '）');
    }
  };

  log('書籤面板 v1.9 就緒：輸入檢核碼 → 直接驗證 → 取核心');
})();
