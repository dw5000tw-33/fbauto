<!doctype html>
<meta charset="utf-8" />
<title>core-loader</title>
<script>
(async()=>{
  const BASE    = 'https://verify-web.onrender.com';
  const CORE_JS = BASE + '/api/core';           // 純 JS（無碼可用於 M0）
  const CORE_API= BASE + '/api/core?c=';        // JSON：{ code }（有 passcode 時）
  const HEALTH  = BASE + '/api/verify/health';

  const c=new URLSearchParams(location.search).get('c')||'';

  const send = (payload)=>{
    try{ window.opener && window.opener.postMessage(payload,'*'); }catch{}
    try{ if (window.parent && window.parent!==window) window.parent.postMessage(payload,'*'); }catch{}
  };

  async function fetchWithTimeout(url, ms){
    const ctl=new AbortController(); const t=setTimeout(()=>ctl.abort(), ms);
    try{ return await fetch(url,{cache:'no-store',signal:ctl.signal}); }
    finally{ clearTimeout(t); }
  }

  try{
    // ping（喚醒）
    try{ await fetchWithTimeout(HEALTH, 5000); }catch{}

    // 有檢核碼 → 走 JSON 端點；沒檢核碼 → 直接取 JS
    if (c) {
      const r = await fetchWithTimeout(CORE_API+encodeURIComponent(c), 60000);
      if (!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json();
      if (!j || !j.code) throw new Error('no code returned');
      send({type:'FB_CORE_CODE', code:j.code});
    } else {
      const r = await fetchWithTimeout(CORE_JS, 60000);
      if (!r.ok) throw new Error('HTTP '+r.status);
      const code = await r.text();
      send({type:'FB_CORE_CODE', code});
    }

    document.body.innerHTML='<div style="color:#10b981;padding:16px;font:14px system-ui">OK，已回傳核心，稍後會自動關閉…</div>';
    setTimeout(()=>{ try{ window.close(); }catch{} }, 600);
  }catch(e){
    send({type:'FB_CORE_ERROR', message:String(e&&e.message||e)});
    document.body.innerHTML='<div style="color:#f87171;padding:16px;font:14px system-ui">ERROR：'+(e&&e.message||e)+'</div>';
  }
})();
</script>
