<!doctype html>
<meta charset="utf-8">
<title>Load Panel</title>
<style>
  html,body{background:#0b1220;color:#cbd5e1;font:14px system-ui;margin:0}
  .wrap{padding:20px}
  code{background:#0b1222;border:1px solid #111827;padding:2px 6px;border-radius:6px}
</style>
<div class="wrap">載入面板中…</div>
<script>
<script>
(async () => {
  const $ = sel => document.querySelector(sel);
  const msg = (t) => $('.wrap').innerHTML = t;

  const params = new URLSearchParams(location.search);
  const nonce = params.get('nonce') || '';
  const BASE = 'https://dw5000tw-33.github.io/fbauto/';
  const versions = ['panel-v1.8.js', 'panel-v1.7.js']; // 依序嘗試

  if (!window.opener) {
    msg('這頁需由書籤開啟（無 <code>opener</code>）。');
    return;
  }
  if (!nonce) {
    msg('缺少 <code>nonce</code>，拒絕回傳面板。');
    return;
  }

  window.opener.postMessage({ type: 'READY', nonce }, '*');

  let code = null, verTried = null;
  for (let ver of versions) {
    try {
      verTried = ver;
      msg('嘗試載入版本：<code>' + ver + '</code> ...');
      const r = await fetch(BASE + ver + '?v=' + Date.now(), { cache:'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      code = await r.text();
      break; // 成功就跳出迴圈
    } catch (e) {
      console.warn('載入失敗：', ver, e);
    }
  }

  if (!code) {
    msg('所有版本載入失敗，請聯絡管理者。');
    return;
  }

  // 回傳給 opener
  window.opener.postMessage({ type: 'PANEL_CODE', nonce, code }, '*');
  msg('OK，已回傳 <code>' + verTried + '</code>；即將自動關閉…');
  setTimeout(() => { try { window.close(); } catch {} }, 900);
})();
</script>
