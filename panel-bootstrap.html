<!doctype html>
<meta charset="utf-8">
<title>Load Panel</title>
<style>
  html,body{background:#0b1220;color:#cbd5e1;font:14px system-ui;margin:0}
  .wrap{padding:20px}
  code{background:#0b1222;border:1px solid #111827;padding:2px 6px;border-radius:6px}
  .hint{color:#9aa7b7}
</style>
<div class="wrap">載入面板中…</div>
<script>
(async () => {
  const $ = sel => document.querySelector(sel);
  const msg = (t) => $('.wrap').innerHTML = t;

  // 讀參數
  const params = new URLSearchParams(location.search);
  const nonce = params.get('nonce') || '';
  const ts    = params.get('ts') || Date.now();

  const BASE = 'https://dw5000tw-33.github.io/fbauto/';
  // 依序嘗試：先新→再舊（沒有 v1.8 也沒關係，會自動跳過）
  const versions = ['panel-v1.9.js', 'panel-v1.8.js'];

  // 基本檢查
  if (!window.opener) { msg('這頁需由書籤開啟（無 <code>opener</code>）。'); return; }
  if (!nonce) { msg('缺少 <code>nonce</code>，拒絕回傳面板。'); return; }

  // 回報 READY（讓 opener 做雙向驗證）
  try { window.opener.postMessage({ type:'READY', nonce }, '*'); }
  catch (e) { msg('無法與 opener 溝通：' + (e.message || e)); return; }

  // 具逾時的 fetch
  async function fetchWithTimeout(url, ms=10000) {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), ms);
    try {
      return await fetch(url, { cache:'no-store', signal: controller.signal });
    } finally { clearTimeout(t); }
  }

  let code = null;
  let usedVersion = null;

  for (const ver of versions) {
    const url = `${BASE}${ver}?v=${ts}`;
    msg(`嘗試載入版本：<code>${ver}</code> …<div class="hint">URL：<code>${url}</code></div>`);
    try {
      const r = await fetchWithTimeout(url, 10000);
      if (!r.ok) throw new Error('HTTP ' + r.status);
      code = await r.text();
      usedVersion = ver;
      break; // 成功就結束
    } catch (e) {
      console.warn('[bootstrap] 載入失敗：', ver, e);
      msg(`載入 <code>${ver}</code> 失敗：<code>${(e && e.message) ? e.message : e}</code><br>嘗試下一個版本…`);
      // 短暫停頓一下比較有感
      await new Promise(res => setTimeout(res, 300));
    }
  }

  if (!code) {
    msg('所有可用版本皆載入失敗。<br>請檢查：<br>- 檔案是否存在於 <code>' + BASE + '</code><br>- GitHub Pages 是否已部署完成<br>- 檔名/路徑大小寫是否正確');
    return;
  }

  // 回傳給 opener
  window.opener.postMessage({ type:'PANEL_CODE', nonce, code }, '*');
  msg('OK，已回傳 <code>' + usedVersion + '</code>；即將自動關閉…');
  setTimeout(() => { try { window.close(); } catch {} }, 900);
})();
</script>
