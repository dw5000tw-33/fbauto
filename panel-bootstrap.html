<!doctype html>
<meta charset="utf-8">
<title>Load Panel</title>
<style>
  html,body{background:#0b1220;color:#cbd5e1;font:14px system-ui;margin:0}
  .wrap{padding:20px}
  code{background:#0b1222;border:1px solid #111827;padding:2px 6px;border-radius:6px}
</style>
<div class="wrap">載入面板中…</div>
<script>
(async () => {
  const $ = sel => document.querySelector(sel);
  const msg = (t) => $('.wrap').innerHTML = t;

  const params = new URLSearchParams(location.search);
  const nonce = params.get('nonce') || '';  // 由書籤傳入
  const PANEL_URL = 'https://dw5000tw-33.github.io/fbauto/panel-v1.8.js';

  // 必須由書籤開啟，且要帶 nonce
  if (!window.opener) {
    msg('這頁需由書籤開啟（無 <code>opener</code>）。');
    return;
  }
  if (!nonce) {
    msg('缺少 <code>nonce</code>，拒絕回傳面板。');
    return;
  }

  // 先向 opener 回報 READY（帶 nonce），讓對方可做雙向驗證（可選）
  try {
    window.opener.postMessage({ type: 'READY', nonce }, '*');
  } catch (e) {
    msg('無法與 opener 溝通：' + (e.message || e));
    return;
  }

  // 取面板核心：加逾時 + 不使用快取
  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), 10000); // 10 秒逾時

  try {
    const r = await fetch(PANEL_URL + '?v=' + Date.now(), {
      cache: 'no-store',
      signal: controller.signal
    });
    if (!r.ok) throw new Error('HTTP ' + r.status);
    const code = await r.text();

    // 回傳給 opener（帶 nonce），僅供握手成功的一方使用
    window.opener.postMessage({ type: 'PANEL_CODE', nonce, code }, '*');

    msg('OK，已回傳面板；即將自動關閉…');
    setTimeout(() => { try { window.close(); } catch {} }, 900);
  } catch (e) {
    const why = (e.name === 'AbortError') ? '連線逾時' : (e.message || e);
    msg('載入失敗：' + why + '<br>請檢查：<br>1) 檔案是否存在 <code>' +
      PANEL_URL + '</code><br>2) GitHub Pages 是否已部署完成<br>3) 檔名/路徑大小寫是否正確');
  } finally {
    clearTimeout(timer);
  }
})();
</script>
